<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Control - PDV Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Adicionar Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        /* Seu CSS existente permanece igual */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .user-actions {
            position: absolute;
            right: 15px;
            top: 15px;
        }
        
        .user-actions i {
            margin-left: 10px;
            font-size: 18px;
        }
        
        .date-display {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2575fc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #2575fc;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        
        .product-list, .client-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .product-item, .client-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .product-item:last-child, .client-item:last-child {
            border-bottom: none;
        }
        
        .product-info, .client-info {
            flex: 2;
        }
        
        .product-stock, .client-value {
            flex: 1;
            text-align: right;
            font-weight: 600;
            color: #2575fc;
        }
        
        .low-stock {
            color: #ff4757;
        }
        
        .nav {
            display: flex;
            background: white;
            border-top: 1px solid #f0f0f0;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            color: #888;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            color: #2575fc;
        }
        
        .nav-item i {
            display: block;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress {
            height: 100%;
            background: #2575fc;
            border-radius: 3px;
        }
        
        .sale-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .sale-info {
            flex: 2;
        }
        
        .sale-value {
            flex: 1;
            text-align: right;
            font-weight: 600;
        }
        
        .paid {
            color: #2ed573;
        }
        
        .pending {
            color: #ffa502;
        }
        
        .overdue {
            color: #ff4757;
        }
        
        .btn {
            background: #2575fc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #1c60cb;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ddd;
        }
        
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff2e43;
        }
        
        .search-bar {
            display: flex;
            margin-bottom: 15px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-right: 10px;
        }
        
        .search-bar button {
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 8px;
            width: 50px;
            cursor: pointer;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .cart-item-info {
            flex: 2;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .quantity-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .quantity-input {
            width: 40px;
            text-align: center;
            margin: 0 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 3px;
        }
        
        .cart-item-price {
            flex: 1;
            text-align: right;
            font-weight: 600;
            color: #2575fc;
        }
        
        .cart-total {
            font-size: 18px;
            font-weight: 700;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #2575fc;
            text-align: right;
        }
        
        .client-form, .product-form {
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #2575fc;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        
        .empty-cart {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        
        .empty-cart i {
            font-size: 48px;
            margin-bottom: 10px;
            color: #ddd;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .payment-option.active {
            border-color: #2575fc;
            background-color: #f0f7ff;
        }
        
        .payment-option input {
            margin-right: 10px;
        }
        
        .due-date-container {
            display: none;
            margin-top: 10px;
        }
        
        .client-actions, .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .client-actions .btn, .product-actions .btn {
            margin-top: 0;
            width: auto;
            flex: 1;
        }

        .product-actions-small {
            display: flex;
            gap: 5px;
        }

        .product-actions-small i {
            cursor: pointer;
            font-size: 16px;
        }

        .fa-edit {
            color: #2575fc;
        }

        .fa-trash {
            color: #ff4757;
        }

        .receivable-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }
        
        /* NOVOS ESTILOS PARA OS RELATÓRIOS */
        .report-section {
            margin-top: 15px;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .report-title {
            font-size: 14px;
            font-weight: 600;
            color: #2575fc;
        }
        
        .report-view-all {
            font-size: 12px;
            color: #888;
            cursor: pointer;
        }
        
        .report-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f9f9f9;
        }
        
        .report-item:last-child {
            border-bottom: none;
        }
        
        .report-item-name {
            flex: 2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .report-item-value {
            flex: 1;
            text-align: right;
            font-weight: 600;
            color: #2575fc;
        }
        
        .report-empty {
            text-align: center;
            padding: 10px;
            color: #888;
            font-size: 12px;
        }
        
        .report-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .report-filter select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        /* Loading styles */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            display: none;
        }
        
        .notification.success {
            background-color: #4CAF50;
        }
        
        .notification.error {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <!-- Notificação -->
    <div class="notification" id="notification"></div>

    <div class="container">
        <div class="header">
            <div class="user-actions">
                <i class="fas fa-bell"></i>
                <i class="fas fa-cog"></i>
            </div>
            <h2>Business Control</h2>
            <div class="date-display">Segunda-feira, 25 de Setembro de 2023</div>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div class="tab-content" id="dashboard">
                <div class="card">
                    <div class="card-title">
                        <span>Visão Geral</span>
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <p>Resumo do desempenho do seu negócio</p>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="today-sales">R$ 0,00</div>
                            <div class="stat-label">Vendas Hoje</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="month-sales">R$ 0,00</div>
                            <div class="stat-label">Vendas Mês</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="goal-percentage">0%</div>
                            <div class="stat-label">Meta</div>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress" id="goal-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- PRODUTOS MAIS VENDIDOS -->
                <div class="card">
                    <div class="card-title">
                        <span>Produtos Mais Vendidos</span>
                        <i class="fas fa-star"></i>
                    </div>
                    
                    <div class="report-section" id="top-products-section">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Carregando dados...</p>
                        </div>
                    </div>
                </div>
                
                <!-- MELHORES CLIENTES -->
                <div class="card">
                    <div class="card-title">
                        <span>Melhores Clientes</span>
                        <i class="fas fa-users"></i>
                    </div>
                    
                    <div class="report-section" id="top-clients-section">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Carregando dados...</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>Próximos Recebimentos</span>
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div id="dashboard-receivables">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Carregando recebimentos...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PDV Tab -->
            <div class="tab-content active" id="pdv">
                <div class="card">
                    <div class="card-title">
                        <span>Ponto de Venda</span>
                        <i class="fas fa-cash-register"></i>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="product-search" placeholder="Digite o código ou nome do produto">
                        <button id="search-product-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <h3>Produtos Disponíveis</h3>
                    <ul class="product-list" id="product-list">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Carregando produtos...</p>
                        </div>
                    </ul>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>Carrinho de Compras</span>
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    
                    <div id="cart-items">
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Seu carrinho está vazio</p>
                        </div>
                    </div>
                    
                    <div class="cart-total" id="cart-total" style="display: none;">
                        Total: R$ <span id="total-value">0,00</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="client-select">Cliente</label>
                        <select id="client-select" class="form-control">
                            <option value="">Selecionar cliente...</option>
                        </select>
                    </div>
                    
                    <button class="btn" id="finalize-sale" disabled>Finalizar Venda</button>
                </div>
            </div>
            
            <!-- Estoque Tab -->
            <div class="tab-content" id="stock">
                <div class="card">
                    <div class="card-title">
                        <span>Controle de Estoque</span>
                        <i class="fas fa-boxes"></i>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="stock-search" placeholder="Buscar produto...">
                        <button id="stock-search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <ul class="product-list" id="stock-list">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Carregando estoque...</p>
                        </div>
                    </ul>
                    
                    <button class="btn" id="add-product-btn">Adicionar Produto</button>
                </div>
                
                <div class="card" id="product-form-card" style="display: none;">
                    <div class="card-title">
                        <span id="product-form-title">Novo Produto</span>
                        <i class="fas fa-box"></i>
                    </div>
                    
                    <div class="product-form">
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="product-name">Nome do Produto</label>
                            <input type="text" id="product-name" placeholder="Nome do produto">
                        </div>
                        <div class="form-group">
                            <label for="product-code">Código</label>
                            <input type="text" id="product-code" placeholder="Código do produto">
                        </div>
                        <div class="form-group">
                            <label for="product-cost">Preço de Custo (R$)</label>
                            <input type="number" id="product-cost" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="product-price">Preço de Venda (R$)</label>
                            <input type="number" id="product-price" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="product-stock">Estoque</label>
                            <input type="number" id="product-stock" placeholder="0" min="0">
                        </div>
                        
                        <div class="product-actions">
                            <button class="btn btn-secondary" id="cancel-product">Cancelar</button>
                            <button class="btn" id="save-product">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Clientes Tab -->
            <div class="tab-content" id="clients">
                <div class="card">
                    <div class="card-title">
                        <span>Gerenciamento de Clientes</span>
                        <i class="fas fa-users"></i>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="client-search" placeholder="Buscar cliente...">
                        <button id="client-search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <ul class="client-list" id="client-list">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Carregando clientes...</p>
                        </div>
                    </ul>
                    
                    <button class="btn" id="add-client-btn">Adicionar Cliente</button>
                </div>
                
                <div class="card" id="client-form-card" style="display: none;">
                    <div class="card-title">
                        <span id="client-form-title">Novo Cliente</span>
                        <i class="fas fa-user-plus"></i>
                    </div>
                    
                    <div class="client-form">
                        <input type="hidden" id="client-id">
                        <div class="form-group">
                            <label for="client-name">Nome</label>
                            <input type="text" id="client-name" placeholder="Nome completo">
                        </div>
                        <div class="form-group">
                            <label for="client-email">E-mail</label>
                            <input type="email" id="client-email" placeholder="exemplo@email.com">
                        </div>
                        <div class="form-group">
                            <label for="client-phone">Telefone</label>
                            <input type="tel" id="client-phone" placeholder="(11) 99999-9999">
                        </div>
                        
                        <div class="client-actions">
                            <button class="btn btn-secondary" id="cancel-client">Cancelar</button>
                            <button class="btn" id="save-client">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Receivables Tab -->
            <div class="tab-content" id="receivables">
                <div class="card">
                    <div class="card-title">
                        <span>Vendas a Receber</span>
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    
                    <ul class="client-list" id="receivables-list">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Carregando recebíveis...</p>
                        </div>
                    </ul>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="to-receive-value">R$ 0,00</div>
                            <div class="stat-label">A Vencer</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="overdue-value">R$ 0,00</div>
                            <div class="stat-label">Atrasado</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-receivables">R$ 0,00</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Relatórios Tab -->
            <div class="tab-content" id="reports">
                <div class="card">
                    <div class="card-title">
                        <span>Relatórios Detalhados</span>
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    
                    <div class="report-filter">
                        <select id="report-period">
                            <option value="today">Hoje</option>
                            <option value="week">Esta Semana</option>
                            <option value="month" selected>Este Mês</option>
                            <option value="all">Todos</option>
                        </select>
                        
                        <select id="report-type">
                            <option value="products">Produtos</option>
                            <option value="clients">Clientes</option>
                            <option value="sales">Vendas</option>
                        </select>
                    </div>
                    
                    <div id="detailed-report">
                        <div class="empty-cart">
                            <p>Selecione o tipo de relatório</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="nav">
            <div class="nav-item" data-tab="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item active" data-tab="pdv">
                <i class="fas fa-cash-register"></i>
                <span>PDV</span>
            </div>
            <div class="nav-item" data-tab="stock">
                <i class="fas fa-boxes"></i>
                <span>Estoque</span>
            </div>
            <div class="nav-item" data-tab="clients">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </div>
            <div class="nav-item" data-tab="receivables">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>A Receber</span>
            </div>
            <div class="nav-item" data-tab="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Relatórios</span>
            </div>
        </div>
    </div>

    <!-- Modal de Finalização de Venda -->
    <div class="modal" id="sale-modal">
        <div class="modal-content">
            <div class="modal-title">Resumo da Venda</div>
            
            <div id="sale-summary">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            
            <div class="form-group">
                <label>Forma de Pagamento</label>
                
                <div class="payment-option active" id="cash-option">
                    <input type="radio" name="payment-method" value="cash" checked>
                    <label for="cash">À Vista</label>
                </div>
                
                <div class="payment-option" id="term-option">
                    <input type="radio" name="payment-method" value="term">
                    <label for="term">A Prazo</label>
                </div>
                
                <div class="due-date-container" id="due-date-container">
                    <div class="form-group">
                        <label for="due-date">Data de Vencimento</label>
                        <input type="date" id="due-date">
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-sale">Cancelar</button>
                <button class="btn" id="confirm-sale">Confirmar Venda</button>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD2WUGIT-4PoVKSJ6Smm2vhFwTh2uJiNh8",
            authDomain: "controle-de-vendas-bf26d.firebaseapp.com",
            databaseURL: "https://controle-de-vendas-bf26d-default-rtdb.firebaseio.com",
            projectId: "controle-de-vendas-bf26d",
            storageBucket: "controle-de-vendas-bf26d.firebasestorage.app",
            messagingSenderId: "692750129361",
            appId: "1:692750129361:web:0eba1efca9a99b29524df0",
            measurementId: "G-TK09V8H5M6"
        };

        // Inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.log('Firebase já inicializado');
        }
        
        const database = firebase.database();

        // Referências do Firebase
        const clientsRef = database.ref('clients');
        const productsRef = database.ref('products');
        const receivablesRef = database.ref('receivables');
        const salesHistoryRef = database.ref('salesHistory');
        const salesDataRef = database.ref('salesData');

        // Dados da aplicação (cache local)
        let cart = [];
        let total = 0;
        let clients = [];
        let products = [];
        let receivables = [];
        let salesHistory = [];
        
        // Dados de vendas para dashboard
        let sales = {
            today: 0,
            month: 0,
            goal: 30000
        };
        
        // Elementos do DOM
        const notification = document.getElementById('notification');
        const productList = document.getElementById('product-list');
        const stockList = document.getElementById('stock-list');
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const totalValue = document.getElementById('total-value');
        const clientSelect = document.getElementById('client-select');
        const finalizeSaleBtn = document.getElementById('finalize-sale');
        const saleModal = document.getElementById('sale-modal');
        const saleSummary = document.getElementById('sale-summary');
        const cancelSaleBtn = document.getElementById('cancel-sale');
        const confirmSaleBtn = document.getElementById('confirm-sale');
        const clientList = document.getElementById('client-list');
        const addClientBtn = document.getElementById('add-client-btn');
        const clientFormCard = document.getElementById('client-form-card');
        const clientFormTitle = document.getElementById('client-form-title');
        const cancelClientBtn = document.getElementById('cancel-client');
        const saveClientBtn = document.getElementById('save-client');
        const clientIdInput = document.getElementById('client-id');
        const clientNameInput = document.getElementById('client-name');
        const clientEmailInput = document.getElementById('client-email');
        const clientPhoneInput = document.getElementById('client-phone');
        const receivablesList = document.getElementById('receivables-list');
        const cashOption = document.getElementById('cash-option');
        const termOption = document.getElementById('term-option');
        const dueDateContainer = document.getElementById('due-date-container');
        const dueDateInput = document.getElementById('due-date');
        const addProductBtn = document.getElementById('add-product-btn');
        const productFormCard = document.getElementById('product-form-card');
        const productFormTitle = document.getElementById('product-form-title');
        const cancelProductBtn = document.getElementById('cancel-product');
        const saveProductBtn = document.getElementById('save-product');
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name');
        const productCodeInput = document.getElementById('product-code');
        const productCostInput = document.getElementById('product-cost');
        const productPriceInput = document.getElementById('product-price');
        const productStockInput = document.getElementById('product-stock');
        const productSearchInput = document.getElementById('product-search');
        const searchProductBtn = document.getElementById('search-product-btn');
        const stockSearchInput = document.getElementById('stock-search');
        const stockSearchBtn = document.getElementById('stock-search-btn');
        const clientSearchInput = document.getElementById('client-search');
        const clientSearchBtn = document.getElementById('client-search-btn');
        const todaySalesElement = document.getElementById('today-sales');
        const monthSalesElement = document.getElementById('month-sales');
        const goalPercentageElement = document.getElementById('goal-percentage');
        const goalProgressElement = document.getElementById('goal-progress');
        const dashboardReceivables = document.getElementById('dashboard-receivables');
        const toReceiveValueElement = document.getElementById('to-receive-value');
        const overdueValueElement = document.getElementById('overdue-value');
        const totalReceivablesElement = document.getElementById('total-receivables');
        const topProductsSection = document.getElementById('top-products-section');
        const topClientsSection = document.getElementById('top-clients-section');
        const reportPeriod = document.getElementById('report-period');
        const reportType = document.getElementById('report-type');
        const detailedReport = document.getElementById('detailed-report');
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadFirebaseData();
            setupEventListeners();
            updateDateTime();
            
            const today = new Date().toISOString().split('T')[0];
            dueDateInput.setAttribute('min', today);
            
            reportPeriod.addEventListener('change', generateReport);
            reportType.addEventListener('change', generateReport);
        });

        // Funções do Firebase - CORRIGIDAS
        function loadFirebaseData() {
            console.log('Carregando dados do Firebase...');
            
            clientsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                clients = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                console.log('Clientes carregados:', clients.length);
                loadClients();
            }, (error) => {
                console.error('Erro ao carregar clientes:', error);
                showNotification('Erro ao carregar clientes', 'error');
            });

            productsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                products = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                console.log('Produtos carregados:', products.length);
                loadProducts();
            }, (error) => {
                console.error('Erro ao carregar produtos:', error);
                showNotification('Erro ao carregar produtos', 'error');
            });

            receivablesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                receivables = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                console.log('Recebíveis carregados:', receivables.length);
                loadReceivables();
            });

            salesHistoryRef.on('value', (snapshot) => {
                const data = snapshot.val();
                salesHistory = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                console.log('Histórico de vendas carregado:', salesHistory.length);
                calculateSalesTotals();
                updateDashboard();
            });

            salesDataRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    sales.today = data.today || 0;
                    sales.month = data.month || 0;
                    sales.goal = data.goal || 30000;
                    updateDashboard();
                }
            });
        }

        // FUNÇÕES CORRIGIDAS PARA SALVAR DADOS
        function saveClientToFirebase(clientData) {
            return new Promise((resolve, reject) => {
                try {
                    if (clientData.id) {
                        // Atualizar cliente existente
                        const { id, ...data } = clientData;
                        clientsRef.child(id).update(data)
                            .then(() => {
                                console.log('Cliente atualizado:', clientData.id);
                                resolve(clientData.id);
                            })
                            .catch(reject);
                    } else {
                        // Criar novo cliente
                        const newClientRef = clientsRef.push();
                        const newId = newClientRef.key;
                        const data = { ...clientData, id: newId };
                        
                        newClientRef.set(data)
                            .then(() => {
                                console.log('Novo cliente criado:', newId);
                                resolve(newId);
                            })
                            .catch(reject);
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        function deleteClientFromFirebase(clientId) {
            return clientsRef.child(clientId).remove();
        }

        function saveProductToFirebase(productData) {
            return new Promise((resolve, reject) => {
                try {
                    if (productData.id) {
                        // Atualizar produto existente
                        const { id, ...data } = productData;
                        productsRef.child(id).update(data)
                            .then(() => {
                                console.log('Produto atualizado:', productData.id);
                                resolve(productData.id);
                            })
                            .catch(reject);
                    } else {
                        // Criar novo produto
                        const newProductRef = productsRef.push();
                        const newId = newProductRef.key;
                        const data = { ...productData, id: newId };
                        
                        newProductRef.set(data)
                            .then(() => {
                                console.log('Novo produto criado:', newId);
                                resolve(newId);
                            })
                            .catch(reject);
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        function deleteProductFromFirebase(productId) {
            return productsRef.child(productId).remove();
        }

        function saveReceivableToFirebase(receivableData) {
            return new Promise((resolve, reject) => {
                const newReceivableRef = receivablesRef.push();
                const newId = newReceivableRef.key;
                const data = { ...receivableData, id: newId };
                
                newReceivableRef.set(data)
                    .then(() => resolve(newId))
                    .catch(reject);
            });
        }

        function updateReceivableStatus(receivableId, status) {
            return receivablesRef.child(receivableId).update({ status: status });
        }

        function saveSaleToHistory(saleData) {
            return new Promise((resolve, reject) => {
                const newSaleRef = salesHistoryRef.push();
                const newId = newSaleRef.key;
                const data = { ...saleData, id: newId };
                
                newSaleRef.set(data)
                    .then(() => resolve(newId))
                    .catch(reject);
            });
        }

        function updateSalesData() {
            return salesDataRef.set(sales);
        }

        function calculateSalesTotals() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            const month = today.getMonth();
            const year = today.getFullYear();

            let todayTotal = 0;
            let monthTotal = 0;

            salesHistory.forEach(sale => {
                const saleDate = new Date(sale.date);
                const saleDateString = saleDate.toISOString().split('T')[0];
                
                if (saleDateString === todayString) {
                    todayTotal += sale.total;
                }
                
                if (saleDate.getMonth() === month && saleDate.getFullYear() === year) {
                    monthTotal += sale.total;
                }
            });

            sales.today = todayTotal;
            sales.month = monthTotal;
            updateSalesData();
        }

        // Função de notificação
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Restante do código permanece igual, mas com as funções corrigidas
        // [O restante do código JavaScript permanece igual...]

        // Configurar event listeners - ATUALIZADO
        function setupEventListeners() {
            // Navegação por abas
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tab).classList.add('active');
                    
                    if (tab === 'reports') {
                        generateReport();
                    }
                });
            });
            
            // Adicionar produto ao carrinho
            productList.addEventListener('click', function(e) {
                const productItem = e.target.closest('.product-item');
                if (productItem) {
                    const productId = productItem.getAttribute('data-id');
                    const productName = productItem.getAttribute('data-name');
                    const productPrice = parseFloat(productItem.getAttribute('data-price'));
                    
                    const existingItem = cart.find(item => item.id === productId);
                    
                    if (existingItem) {
                        const product = products.find(p => p.id === productId);
                        if (existingItem.quantity < product.stock) {
                            existingItem.quantity++;
                        } else {
                            showNotification('Estoque insuficiente para este produto!', 'error');
                        }
                    } else {
                        const product = products.find(p => p.id === productId);
                        if (product && product.stock > 0) {
                            cart.push({
                                id: productId,
                                name: productName,
                                price: productPrice,
                                quantity: 1
                            });
                            showNotification('Produto adicionado ao carrinho!');
                        } else {
                            showNotification('Produto sem estoque disponível!', 'error');
                        }
                    }
                    
                    updateCart();
                }
            });
            
            // Finalizar venda
            finalizeSaleBtn.addEventListener('click', function() {
                if (cart.length === 0) return;
                
                let summaryHTML = '<div class="sale-summary">';
                cart.forEach(item => {
                    summaryHTML += `
                        <div class="sale-item">
                            <div class="sale-info">${item.name} x ${item.quantity}</div>
                            <div class="sale-value">R$ ${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                    `;
                });
                summaryHTML += `
                    <div class="cart-total">
                        Total: R$ ${total.toFixed(2)}
                    </div>
                `;
                
                const clientId = clientSelect.value;
                if (clientId) {
                    const client = clients.find(c => c.id === clientId);
                    summaryHTML += `<p><strong>Cliente:</strong> ${client.name}</p>`;
                }
                
                summaryHTML += '</div>';
                saleSummary.innerHTML = summaryHTML;
                saleModal.style.display = 'flex';
            });
            
            // Opções de pagamento
            cashOption.addEventListener('click', function() {
                cashOption.classList.add('active');
                termOption.classList.remove('active');
                document.querySelector('input[name="payment-method"][value="cash"]').checked = true;
                dueDateContainer.style.display = 'none';
            });
            
            termOption.addEventListener('click', function() {
                termOption.classList.add('active');
                cashOption.classList.remove('active');
                document.querySelector('input[name="payment-method"][value="term"]').checked = true;
                dueDateContainer.style.display = 'block';
            });
            
            // Confirmar venda - CORRIGIDO
            confirmSaleBtn.addEventListener('click', function() {
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                const clientId = clientSelect.value;
                const clientName = clientId ? clients.find(c => c.id === clientId).name : 'Cliente não identificado';
                
                if (paymentMethod === 'term') {
                    const dueDate = dueDateInput.value;
                    if (!dueDate) {
                        showNotification('Selecione uma data de vencimento!', 'error');
                        return;
                    }
                    
                    const receivable = {
                        client: clientName,
                        value: total,
                        dueDate: dueDate,
                        status: 'pending',
                        date: new Date().toISOString()
                    };
                    
                    saveReceivableToFirebase(receivable)
                        .then(() => {
                            console.log('Recebível salvo com sucesso');
                        })
                        .catch(error => {
                            console.error('Erro ao salvar recebível:', error);
                            showNotification('Erro ao salvar recebível', 'error');
                        });
                }
                
                const saleDate = new Date().toISOString();
                const sale = {
                    date: saleDate,
                    clientId: clientId,
                    clientName: clientName,
                    items: [...cart],
                    total: total,
                    paymentMethod: paymentMethod
                };
                
                saveSaleToHistory(sale)
                    .then(() => {
                        // Atualizar cliente
                        if (clientId) {
                            const client = clients.find(c => c.id === clientId);
                            if (client) {
                                client.totalPurchases = (client.totalPurchases || 0) + total;
                                saveClientToFirebase(client);
                            }
                        }
                        
                        // Atualizar estoque
                        updateStockAfterSale();
                        
                        // Limpar carrinho
                        cart = [];
                        updateCart();
                        saleModal.style.display = 'none';
                        clientSelect.value = '';
                        
                        showNotification('Venda finalizada com sucesso!');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar venda:', error);
                        showNotification('Erro ao finalizar venda!', 'error');
                    });
            });
            
            // Cancelar venda
            cancelSaleBtn.addEventListener('click', function() {
                saleModal.style.display = 'none';
            });
            
            // Clientes - Adicionar/Editar - CORRIGIDO
            addClientBtn.addEventListener('click', function() {
                clientFormTitle.textContent = 'Novo Cliente';
                clientIdInput.value = '';
                clientNameInput.value = '';
                clientEmailInput.value = '';
                clientPhoneInput.value = '';
                clientFormCard.style.display = 'block';
            });
            
            cancelClientBtn.addEventListener('click', function() {
                clientFormCard.style.display = 'none';
            });
            
            saveClientBtn.addEventListener('click', function() {
                const id = clientIdInput.value;
                const name = clientNameInput.value.trim();
                const email = clientEmailInput.value.trim();
                const phone = clientPhoneInput.value.trim();
                
                if (!name) {
                    showNotification('Preencha o nome do cliente!', 'error');
                    return;
                }
                
                const clientData = {
                    name: name,
                    email: email,
                    phone: phone,
                    totalPurchases: 0
                };
                
                if (id) {
                    // Preservar compras ao editar
                    const existingClient = clients.find(c => c.id === id);
                    if (existingClient) {
                        clientData.totalPurchases = existingClient.totalPurchases || 0;
                    }
                    clientData.id = id;
                }
                
                saveClientToFirebase(clientData)
                    .then(() => {
                        clientFormCard.style.display = 'none';
                        showNotification(id ? 'Cliente atualizado!' : 'Cliente adicionado!');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar cliente:', error);
                        showNotification('Erro ao salvar cliente!', 'error');
                    });
            });
            
            // Produtos - Adicionar/Editar - CORRIGIDO
            addProductBtn.addEventListener('click', function() {
                productFormTitle.textContent = 'Novo Produto';
                productIdInput.value = '';
                productNameInput.value = '';
                productCodeInput.value = '';
                productCostInput.value = '';
                productPriceInput.value = '';
                productStockInput.value = '';
                productFormCard.style.display = 'block';
            });
            
            cancelProductBtn.addEventListener('click', function() {
                productFormCard.style.display = 'none';
            });
            
            saveProductBtn.addEventListener('click', function() {
                const id = productIdInput.value;
                const name = productNameInput.value.trim();
                const code = productCodeInput.value.trim();
                const cost = parseFloat(productCostInput.value) || 0;
                const price = parseFloat(productPriceInput.value) || 0;
                const stock = parseInt(productStockInput.value) || 0;
                
                if (!name || !code) {
                    showNotification('Preencha nome e código do produto!', 'error');
                    return;
                }
                
                if (price <= 0) {
                    showNotification('Preço de venda deve ser maior que zero!', 'error');
                    return;
                }
                
                const productData = {
                    name: name,
                    code: code,
                    cost: cost,
                    price: price,
                    stock: stock
                };
                
                if (id) {
                    productData.id = id;
                }
                
                saveProductToFirebase(productData)
                    .then(() => {
                        productFormCard.style.display = 'none';
                        showNotification(id ? 'Produto atualizado!' : 'Produto adicionado!');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar produto:', error);
                        showNotification('Erro ao salvar produto!', 'error');
                    });
            });
            
            // Buscar produtos
            searchProductBtn.addEventListener('click', searchProducts);
            productSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchProducts();
            });
            
            // Buscar estoque
            stockSearchBtn.addEventListener('click', searchStock);
            stockSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchStock();
            });
            
            // Buscar clientes
            clientSearchBtn.addEventListener('click', searchClients);
            clientSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchClients();
            });
        }

        // [Restante das funções permanece igual...]

    </script>
</body>
</html>
