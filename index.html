<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Control - PDV Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .user-actions {
            position: absolute;
            right: 15px;
            top: 15px;
        }
        
        .user-actions i {
            margin-left: 10px;
            font-size: 18px;
        }
        
        .date-display {
            font-size: 14px;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2575fc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #2575fc;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        
        .product-list, .client-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .product-item, .client-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .product-item:last-child, .client-item:last-child {
            border-bottom: none;
        }
        
        .product-info, .client-info {
            flex: 2;
        }
        
        .product-stock, .client-value {
            flex: 1;
            text-align: right;
            font-weight: 600;
            color: #2575fc;
        }
        
        .low-stock {
            color: #ff4757;
        }
        
        .nav {
            display: flex;
            background: white;
            border-top: 1px solid #f0f0f0;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            color: #888;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .nav-item.active {
            color: #2575fc;
        }
        
        .nav-item i {
            display: block;
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress {
            height: 100%;
            background: #2575fc;
            border-radius: 3px;
        }
        
        .sale-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .sale-info {
            flex: 2;
        }
        
        .sale-value {
            flex: 1;
            text-align: right;
            font-weight: 600;
        }
        
        .paid {
            color: #2ed573;
        }
        
        .pending {
            color: #ffa502;
        }
        
        .overdue {
            color: #ff4757;
        }
        
        .btn {
            background: #2575fc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #1c60cb;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #ddd;
        }
        
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff2e43;
        }
        
        .search-bar {
            display: flex;
            margin-bottom: 15px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-right: 10px;
        }
        
        .search-bar button {
            background: #2575fc;
            color: white;
            border: none;
            border-radius: 8px;
            width: 50px;
            cursor: pointer;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .cart-item-info {
            flex: 2;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .quantity-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .quantity-input {
            width: 40px;
            text-align: center;
            margin: 0 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 3px;
        }
        
        .cart-item-price {
            flex: 1;
            text-align: right;
            font-weight: 600;
            color: #2575fc;
        }
        
        .cart-total {
            font-size: 18px;
            font-weight: 700;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #2575fc;
            text-align: right;
        }
        
        .client-form, .product-form {
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #2575fc;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }
        
        .empty-cart {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        
        .empty-cart i {
            font-size: 48px;
            margin-bottom: 10px;
            color: #ddd;
        }
        
        .payment-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .payment-option.active {
            border-color: #2575fc;
            background-color: #f0f7ff;
        }
        
        .payment-option input {
            margin-right: 10px;
        }
        
        .due-date-container {
            display: none;
            margin-top: 10px;
        }
        
        .client-actions, .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .client-actions .btn, .product-actions .btn {
            margin-top: 0;
            width: auto;
            flex: 1;
        }

        .product-actions-small {
            display: flex;
            gap: 5px;
        }

        .product-actions-small i {
            cursor: pointer;
            font-size: 16px;
        }

        .fa-edit {
            color: #2575fc;
        }

        .fa-trash {
            color: #ff4757;
        }

        .receivable-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }
        
        .report-section {
            margin-top: 15px;
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .report-title {
            font-size: 14px;
            font-weight: 600;
            color: #2575fc;
        }
        
        .report-view-all {
            font-size: 12px;
            color: #888;
            cursor: pointer;
        }
        
        .report-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f9f9f9;
        }
        
        .report-item:last-child {
            border-bottom: none;
        }
        
        .report-item-name {
            flex: 2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .report-item-value {
            flex: 1;
            text-align: right;
            font-weight: 600;
            color: #2575fc;
        }
        
        .report-empty {
            text-align: center;
            padding: 10px;
            color: #888;
            font-size: 12px;
        }
        
        .report-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .report-filter select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 10px;
            color: #2575fc;
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-actions">
                <i class="fas fa-bell"></i>
                <i class="fas fa-cog"></i>
            </div>
            <h2>Business Control</h2>
            <div class="date-display">Carregando...</div>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div class="tab-content" id="dashboard">
                <div class="card">
                    <div class="card-title">
                        <span>Visão Geral</span>
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <p>Resumo do desempenho do seu negócio</p>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="today-sales">R$ 0,00</div>
                            <div class="stat-label">Vendas Hoje</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="month-sales">R$ 0,00</div>
                            <div class="stat-label">Vendas Mês</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="goal-percentage">0%</div>
                            <div class="stat-label">Meta</div>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress" id="goal-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>Produtos Mais Vendidos</span>
                        <i class="fas fa-star"></i>
                    </div>
                    
                    <div class="report-section" id="top-products-section">
                        <div class="loading">
                            <i class="fas fa-spinner"></i> Carregando...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>Melhores Clientes</span>
                        <i class="fas fa-users"></i>
                    </div>
                    
                    <div class="report-section" id="top-clients-section">
                        <div class="loading">
                            <i class="fas fa-spinner"></i> Carregando...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>Próximos Recebimentos</span>
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div id="dashboard-receivables">
                        <div class="loading">
                            <i class="fas fa-spinner"></i> Carregando...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PDV Tab -->
            <div class="tab-content active" id="pdv">
                <div class="card">
                    <div class="card-title">
                        <span>Ponto de Venda</span>
                        <i class="fas fa-cash-register"></i>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="product-search" placeholder="Digite o código ou nome do produto">
                        <button id="search-product-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <h3>Produtos Disponíveis</h3>
                    <ul class="product-list" id="product-list">
                        <div class="loading">
                            <i class="fas fa-spinner"></i> Carregando produtos...
                        </div>
                    </ul>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <span>Carrinho de Compras</span>
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    
                    <div id="cart-items">
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Seu carrinho está vazio</p>
                        </div>
                    </div>
                    
                    <div class="cart-total" id="cart-total" style="display: none;">
                        Total: R$ <span id="total-value">0,00</span>
                    </div>
                    
                    <div class="form-group">
                        <label for="client-select">Cliente</label>
                        <select id="client-select" class="form-control">
                            <option value="">Selecionar cliente...</option>
                        </select>
                    </div>
                    
                    <button class="btn" id="finalize-sale" disabled>Finalizar Venda</button>
                </div>
            </div>
            
            <!-- Estoque Tab -->
            <div class="tab-content" id="stock">
                <div class="card">
                    <div class="card-title">
                        <span>Controle de Estoque</span>
                        <i class="fas fa-boxes"></i>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="stock-search" placeholder="Buscar produto...">
                        <button id="stock-search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <ul class="product-list" id="stock-list">
                        <div class="loading">
                            <i class="fas fa-spinner"></i> Carregando estoque...
                        </div>
                    </ul>
                    
                    <button class="btn" id="add-product-btn">Adicionar Produto</button>
                </div>
                
                <div class="card" id="product-form-card" style="display: none;">
                    <div class="card-title">
                        <span id="product-form-title">Novo Produto</span>
                        <i class="fas fa-box"></i>
                    </div>
                    
                    <div class="product-form">
                        <input type="hidden" id="product-id">
                        <div class="form-group">
                            <label for="product-name">Nome do Produto</label>
                            <input type="text" id="product-name" placeholder="Nome do produto">
                        </div>
                        <div class="form-group">
                            <label for="product-code">Código</label>
                            <input type="text" id="product-code" placeholder="Código do produto">
                        </div>
                        <div class="form-group">
                            <label for="product-cost">Preço de Custo (R$)</label>
                            <input type="number" id="product-cost" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="product-price">Preço de Venda (R$)</label>
                            <input type="number" id="product-price" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="product-stock">Estoque</label>
                            <input type="number" id="product-stock" placeholder="0" min="0">
                        </div>
                        
                        <div class="product-actions">
                            <button class="btn btn-secondary" id="cancel-product">Cancelar</button>
                            <button class="btn" id="save-product">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Clientes Tab -->
            <div class="tab-content" id="clients">
                <div class="card">
                    <div class="card-title">
                        <span>Gerenciamento de Clientes</span>
                        <i class="fas fa-users"></i>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="client-search" placeholder="Buscar cliente...">
                        <button id="client-search-btn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <ul class="client-list" id="client-list">
                        <div class="loading">
                            <i class="fas fa-spinner"></i> Carregando clientes...
                        </div>
                    </ul>
                    
                    <button class="btn" id="add-client-btn">Adicionar Cliente</button>
                </div>
                
                <div class="card" id="client-form-card" style="display: none;">
                    <div class="card-title">
                        <span id="client-form-title">Novo Cliente</span>
                        <i class="fas fa-user-plus"></i>
                    </div>
                    
                    <div class="client-form">
                        <input type="hidden" id="client-id">
                        <div class="form-group">
                            <label for="client-name">Nome</label>
                            <input type="text" id="client-name" placeholder="Nome completo">
                        </div>
                        <div class="form-group">
                            <label for="client-email">E-mail</label>
                            <input type="email" id="client-email" placeholder="exemplo@email.com">
                        </div>
                        <div class="form-group">
                            <label for="client-phone">Telefone</label>
                            <input type="tel" id="client-phone" placeholder="(11) 99999-9999">
                        </div>
                        
                        <div class="client-actions">
                            <button class="btn btn-secondary" id="cancel-client">Cancelar</button>
                            <button class="btn" id="save-client">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Receivables Tab -->
            <div class="tab-content" id="receivables">
                <div class="card">
                    <div class="card-title">
                        <span>Vendas a Receber</span>
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    
                    <ul class="client-list" id="receivables-list">
                        <div class="loading">
                            <i class="fas fa-spinner"></i> Carregando recebíveis...
                        </div>
                    </ul>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="to-receive-value">R$ 0,00</div>
                            <div class="stat-label">A Vencer</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="overdue-value">R$ 0,00</div>
                            <div class="stat-label">Atrasado</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="total-receivables">R$ 0,00</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Relatórios Tab -->
            <div class="tab-content" id="reports">
                <div class="card">
                    <div class="card-title">
                        <span>Relatórios Detalhados</span>
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    
                    <div class="report-filter">
                        <select id="report-period">
                            <option value="today">Hoje</option>
                            <option value="week">Esta Semana</option>
                            <option value="month" selected>Este Mês</option>
                            <option value="all">Todos</option>
                        </select>
                        
                        <select id="report-type">
                            <option value="products">Produtos</option>
                            <option value="clients">Clientes</option>
                            <option value="sales">Vendas</option>
                        </select>
                    </div>
                    
                    <div id="detailed-report">
                        <div class="loading">
                            <i class="fas fa-spinner"></i> Carregando relatórios...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="nav">
            <div class="nav-item" data-tab="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item active" data-tab="pdv">
                <i class="fas fa-cash-register"></i>
                <span>PDV</span>
            </div>
            <div class="nav-item" data-tab="stock">
                <i class="fas fa-boxes"></i>
                <span>Estoque</span>
            </div>
            <div class="nav-item" data-tab="clients">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </div>
            <div class="nav-item" data-tab="receivables">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>A Receber</span>
            </div>
            <div class="nav-item" data-tab="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Relatórios</span>
            </div>
        </div>
    </div>

    <!-- Modal de Finalização de Venda -->
    <div class="modal" id="sale-modal">
        <div class="modal-content">
            <div class="modal-title">Resumo da Venda</div>
            
            <div id="sale-summary">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            
            <div class="form-group">
                <label>Forma de Pagamento</label>
                
                <div class="payment-option active" id="cash-option">
                    <input type="radio" name="payment-method" value="cash" checked>
                    <label for="cash">À Vista</label>
                </div>
                
                <div class="payment-option" id="term-option">
                    <input type="radio" name="payment-method" value="term">
                    <label for="term">A Prazo</label>
                </div>
                
                <div class="due-date-container" id="due-date-container">
                    <div class="form-group">
                        <label for="due-date">Data de Vencimento</label>
                        <input type="date" id="due-date">
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-sale">Cancelar</button>
                <button class="btn" id="confirm-sale">Confirmar Venda</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURAÇÃO FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyD2WUGIT-4PoVKSJ6Smm2vhFwTh2uJiNh8",
            authDomain: "controle-de-vendas-bf26d.firebaseapp.com",
            databaseURL: "https://controle-de-vendas-bf26d-default-rtdb.firebaseio.com",
            projectId: "controle-de-vendas-bf26d",
            storageBucket: "controle-de-vendas-bf26d.firebasestorage.app",
            messagingSenderId: "692750129361",
            appId: "1:692750129361:web:0eba1efca9a99b29524df0",
            measurementId: "G-TK09V8H5M6"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Referências do Firebase
        const dbRef = {
            products: database.ref('products'),
            clients: database.ref('clients'),
            sales: database.ref('sales'),
            receivables: database.ref('receivables'),
            salesHistory: database.ref('salesHistory'),
            appData: database.ref('appData')
        };

        // ==================== DADOS DA APLICAÇÃO ====================
        let cart = [];
        let total = 0;
        let clients = [];
        let products = [];
        let receivables = [];
        let salesHistory = [];
        
        let sales = {
            today: 0,
            month: 0,
            goal: 30000
        };

        // ==================== ELEMENTOS DO DOM ====================
        const productList = document.getElementById('product-list');
        const stockList = document.getElementById('stock-list');
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const totalValue = document.getElementById('total-value');
        const clientSelect = document.getElementById('client-select');
        const finalizeSaleBtn = document.getElementById('finalize-sale');
        const saleModal = document.getElementById('sale-modal');
        const saleSummary = document.getElementById('sale-summary');
        const cancelSaleBtn = document.getElementById('cancel-sale');
        const confirmSaleBtn = document.getElementById('confirm-sale');
        const clientList = document.getElementById('client-list');
        const addClientBtn = document.getElementById('add-client-btn');
        const clientFormCard = document.getElementById('client-form-card');
        const clientFormTitle = document.getElementById('client-form-title');
        const cancelClientBtn = document.getElementById('cancel-client');
        const saveClientBtn = document.getElementById('save-client');
        const clientIdInput = document.getElementById('client-id');
        const clientNameInput = document.getElementById('client-name');
        const clientEmailInput = document.getElementById('client-email');
        const clientPhoneInput = document.getElementById('client-phone');
        const receivablesList = document.getElementById('receivables-list');
        const cashOption = document.getElementById('cash-option');
        const termOption = document.getElementById('term-option');
        const dueDateContainer = document.getElementById('due-date-container');
        const dueDateInput = document.getElementById('due-date');
        const addProductBtn = document.getElementById('add-product-btn');
        const productFormCard = document.getElementById('product-form-card');
        const productFormTitle = document.getElementById('product-form-title');
        const cancelProductBtn = document.getElementById('cancel-product');
        const saveProductBtn = document.getElementById('save-product');
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name');
        const productCodeInput = document.getElementById('product-code');
        const productCostInput = document.getElementById('product-cost');
        const productPriceInput = document.getElementById('product-price');
        const productStockInput = document.getElementById('product-stock');
        const productSearchInput = document.getElementById('product-search');
        const searchProductBtn = document.getElementById('search-product-btn');
        const stockSearchInput = document.getElementById('stock-search');
        const stockSearchBtn = document.getElementById('stock-search-btn');
        const clientSearchInput = document.getElementById('client-search');
        const clientSearchBtn = document.getElementById('client-search-btn');
        const todaySalesElement = document.getElementById('today-sales');
        const monthSalesElement = document.getElementById('month-sales');
        const goalPercentageElement = document.getElementById('goal-percentage');
        const goalProgressElement = document.getElementById('goal-progress');
        const dashboardReceivables = document.getElementById('dashboard-receivables');
        const toReceiveValueElement = document.getElementById('to-receive-value');
        const overdueValueElement = document.getElementById('overdue-value');
        const totalReceivablesElement = document.getElementById('total-receivables');
        const topProductsSection = document.getElementById('top-products-section');
        const topClientsSection = document.getElementById('top-clients-section');
        const reportPeriod = document.getElementById('report-period');
        const reportType = document.getElementById('report-type');
        const detailedReport = document.getElementById('detailed-report');

        // ==================== FUNÇÕES FIREBASE ====================
        function loadFirebaseData() {
            console.log('🔥 Conectando ao Firebase...');
            
            // Carregar produtos
            dbRef.products.on('value', (snapshot) => {
                products = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        products.push({ 
                            id: key, 
                            name: data[key].name || '',
                            code: data[key].code || '',
                            cost: data[key].cost || 0,
                            price: data[key].price || 0,
                            stock: data[key].stock || 0
                        });
                    });
                }
                console.log(`📦 ${products.length} produtos carregados`);
                loadProducts();
            }, (error) => {
                console.error('Erro ao carregar produtos:', error);
            });

            // Carregar clientes
            dbRef.clients.on('value', (snapshot) => {
                clients = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        clients.push({ 
                            id: key, 
                            name: data[key].name || '',
                            email: data[key].email || '',
                            phone: data[key].phone || '',
                            totalPurchases: data[key].totalPurchases || 0
                        });
                    });
                }
                console.log(`👥 ${clients.length} clientes carregados`);
                loadClients();
            }, (error) => {
                console.error('Erro ao carregar clientes:', error);
            });

            // Carregar recebíveis
            dbRef.receivables.on('value', (snapshot) => {
                receivables = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        receivables.push({ 
                            id: key, 
                            client: data[key].client || '',
                            value: data[key].value || 0,
                            dueDate: data[key].dueDate || '',
                            status: data[key].status || 'pending'
                        });
                    });
                }
                console.log(`💰 ${receivables.length} recebíveis carregados`);
                loadReceivables();
                updateDashboardReceivables();
            }, (error) => {
                console.error('Erro ao carregar recebíveis:', error);
            });

            // Carregar histórico de vendas
            dbRef.salesHistory.on('value', (snapshot) => {
                salesHistory = [];
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(key => {
                        salesHistory.push({ 
                            id: key, 
                            date: data[key].date || '',
                            clientId: data[key].clientId || '',
                            clientName: data[key].clientName || '',
                            items: data[key].items || [],
                            total: data[key].total || 0,
                            paymentMethod: data[key].paymentMethod || 'cash'
                        });
                    });
                }
                console.log(`📊 ${salesHistory.length} vendas no histórico`);
                updateSalesData();
                updateTopProductsReport();
                updateTopClientsReport();
            }, (error) => {
                console.error('Erro ao carregar histórico de vendas:', error);
            });

            // Carregar dados das vendas
            dbRef.appData.child('sales').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    sales.today = data.today || 0;
                    sales.month = data.month || 0;
                    sales.goal = data.goal || 30000;
                }
                console.log('📈 Dados de vendas carregados');
                updateDashboard();
            }, (error) => {
                console.error('Erro ao carregar dados de vendas:', error);
            });
        }

        function saveProductToFirebase(product) {
            return new Promise((resolve, reject) => {
                try {
                    if (product.id && product.id.length > 2) {
                        // Atualizar produto existente
                        dbRef.products.child(product.id).update({
                            name: product.name,
                            code: product.code,
                            cost: parseFloat(product.cost) || 0,
                            price: parseFloat(product.price) || 0,
                            stock: parseInt(product.stock) || 0
                        }, (error) => {
                            if (error) {
                                reject(error);
                            } else {
                                resolve(product.id);
                            }
                        });
                    } else {
                        // Criar novo produto
                        const newProductRef = dbRef.products.push({
                            name: product.name,
                            code: product.code,
                            cost: parseFloat(product.cost) || 0,
                            price: parseFloat(product.price) || 0,
                            stock: parseInt(product.stock) || 0
                        }, (error) => {
                            if (error) {
                                reject(error);
                            } else {
                                resolve(newProductRef.key);
                            }
                        });
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        function saveClientToFirebase(client) {
            return new Promise((resolve, reject) => {
                try {
                    if (client.id && client.id.length > 2) {
                        // Atualizar cliente existente
                        dbRef.clients.child(client.id).update({
                            name: client.name,
                            email: client.email,
                            phone: client.phone,
                            totalPurchases: parseFloat(client.totalPurchases) || 0
                        }, (error) => {
                            if (error) {
                                reject(error);
                            } else {
                                resolve(client.id);
                            }
                        });
                    } else {
                        // Criar novo cliente
                        const newClientRef = dbRef.clients.push({
                            name: client.name,
                            email: client.email,
                            phone: client.phone,
                            totalPurchases: 0
                        }, (error) => {
                            if (error) {
                                reject(error);
                            } else {
                                resolve(newClientRef.key);
                            }
                        });
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        function saveSaleToFirebase(sale) {
            return new Promise((resolve, reject) => {
                try {
                    const saleRef = dbRef.salesHistory.push({
                        date: sale.date,
                        clientId: sale.clientId || null,
                        clientName: sale.clientName || 'Cliente não identificado',
                        items: sale.items.map(item => ({
                            id: item.id,
                            name: item.name,
                            price: parseFloat(item.price),
                            quantity: parseInt(item.quantity)
                        })),
                        total: parseFloat(sale.total),
                        paymentMethod: sale.paymentMethod
                    }, (error) => {
                        if (error) {
                            reject(error);
                        } else {
                            resolve(saleRef.key);
                        }
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }

        function saveReceivableToFirebase(receivable) {
            return new Promise((resolve, reject) => {
                try {
                    if (receivable.id && receivable.id.length > 2) {
                        // Atualizar recebível existente
                        dbRef.receivables.child(receivable.id).update({
                            client: receivable.client,
                            value: parseFloat(receivable.value),
                            dueDate: receivable.dueDate,
                            status: receivable.status
                        }, (error) => {
                            if (error) {
                                reject(error);
                            } else {
                                resolve(receivable.id);
                            }
                        });
                    } else {
                        // Criar novo recebível
                        const newReceivableRef = dbRef.receivables.push({
                            client: receivable.client,
                            value: parseFloat(receivable.value),
                            dueDate: receivable.dueDate,
                            status: 'pending'
                        }, (error) => {
                            if (error) {
                                reject(error);
                            } else {
                                resolve(newReceivableRef.key);
                            }
                        });
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        function deleteProductFromFirebase(productId) {
            return new Promise((resolve, reject) => {
                dbRef.products.child(productId).remove((error) => {
                    if (error) {
                        reject(error);
                    } else {
                        resolve();
                    }
                });
            });
        }

        function deleteClientFromFirebase(clientId) {
            return new Promise((resolve, reject) => {
                dbRef.clients.child(clientId).remove((error) => {
                    if (error) {
                        reject(error);
                    } else {
                        resolve();
                    }
                });
            });
        }

        function updateStockInFirebase(productId, newStock) {
            return new Promise((resolve, reject) => {
                dbRef.products.child(productId).update({
                    stock: parseInt(newStock)
                }, (error) => {
                    if (error) {
                        reject(error);
                    } else {
                        resolve();
                    }
                });
            });
        }

        // ==================== FUNÇÕES ORIGINAIS COMPLETAS ====================
        function loadClients() {
            clientSelect.innerHTML = '<option value="">Selecionar cliente...</option>';
            clientList.innerHTML = '';

            if (clients.length === 0) {
                clientList.innerHTML = '<div class="empty-cart"><p>Nenhum cliente cadastrado</p></div>';
                return;
            }

            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelect.appendChild(option);

                const li = document.createElement('li');
                li.className = 'client-item';
                li.innerHTML = `
                    <div class="client-info">
                        <strong>${client.name}</strong>
                        <div>${client.email} | ${client.phone}</div>
                        <div>Total em compras: R$ ${(client.totalPurchases || 0).toFixed(2)}</div>
                    </div>
                    <div class="client-actions">
                        <i class="fas fa-edit edit-client" data-id="${client.id}"></i>
                        <i class="fas fa-trash delete-client" data-id="${client.id}"></i>
                    </div>
                `;
                clientList.appendChild(li);
            });

            document.querySelectorAll('.edit-client').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = this.getAttribute('data-id');
                    editClient(clientId);
                });
            });

            document.querySelectorAll('.delete-client').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = this.getAttribute('data-id');
                    deleteClient(clientId);
                });
            });
        }

        function loadProducts() {
            productList.innerHTML = '';
            stockList.innerHTML = '';

            if (products.length === 0) {
                productList.innerHTML = '<div class="empty-cart"><p>Nenhum produto cadastrado</p></div>';
                stockList.innerHTML = '<div class="empty-cart"><p>Nenhum produto cadastrado</p></div>';
                return;
            }

            products.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.setAttribute('data-id', product.id);
                li.setAttribute('data-name', product.name);
                li.setAttribute('data-price', product.price);
                li.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div>R$ ${product.price.toFixed(2)} | Cód: ${product.code}</div>
                    </div>
                    <div class="product-stock ${product.stock <= 5 ? 'low-stock' : ''}">Estoque: ${product.stock}</div>
                `;
                productList.appendChild(li);
            });

            products.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div>Cód: ${product.code} | R$ ${product.price.toFixed(2)}</div>
                        <div>Custo: R$ ${product.cost.toFixed(2)} | Margem: ${calculateMargin(product.cost, product.price)}%</div>
                    </div>
                    <div class="product-stock ${product.stock <= 5 ? 'low-stock' : ''}">
                        ${product.stock} unid.
                        <div class="product-actions-small">
                            <i class="fas fa-edit edit-product" data-id="${product.id}"></i>
                            <i class="fas fa-trash delete-product" data-id="${product.id}"></i>
                        </div>
                    </div>
                `;
                stockList.appendChild(li);
            });

            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    editProduct(productId);
                });
            });

            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    deleteProduct(productId);
                });
            });
        }

        function calculateMargin(cost, price) {
            if (cost === 0) return 100;
            return (((price - cost) / cost) * 100).toFixed(2);
        }

        function loadReceivables() {
            receivablesList.innerHTML = '';

            if (receivables.length === 0) {
                receivablesList.innerHTML = '<div class="empty-cart"><p>Nenhuma venda a receber</p></div>';
                toReceiveValueElement.textContent = 'R$ 0,00';
                overdueValueElement.textContent = 'R$ 0,00';
                totalReceivablesElement.textContent = 'R$ 0,00';
                return;
            }

            let toReceiveTotal = 0;
            let overdueTotal = 0;
            let totalReceivables = 0;

            receivables.forEach(item => {
                const today = new Date();
                const dueDate = new Date(item.dueDate);
                let status = 'pending';
                let statusClass = 'pending';

                if (item.status === 'paid') {
                    status = 'paid';
                    statusClass = 'paid';
                } else if (dueDate < today) {
                    status = 'overdue';
                    statusClass = 'overdue';
                    overdueTotal += item.value;
                } else {
                    toReceiveTotal += item.value;
                }

                totalReceivables += item.value;

                const formattedDate = dueDate.toLocaleDateString('pt-BR');

                const li = document.createElement('li');
                li.className = 'client-item';
                li.innerHTML = `
                    <div class="client-info">
                        <strong>${item.client}</strong>
                        <div>Vencimento: ${formattedDate}</div>
                        ${status !== 'paid' ? `
                        <div class="receivable-actions">
                            <button class="btn btn-small receive-payment" data-id="${item.id}">Receber</button>
                        </div>
                        ` : ''}
                    </div>
                    <div class="client-value ${statusClass}">R$ ${item.value.toFixed(2)}</div>
                `;
                receivablesList.appendChild(li);
            });

            toReceiveValueElement.textContent = `R$ ${toReceiveTotal.toFixed(2)}`;
            overdueValueElement.textContent = `R$ ${overdueTotal.toFixed(2)}`;
            totalReceivablesElement.textContent = `R$ ${totalReceivables.toFixed(2)}`;

            document.querySelectorAll('.receive-payment').forEach(btn => {
                btn.addEventListener('click', function() {
                    const receivableId = this.getAttribute('data-id');
                    receivePayment(receivableId);
                });
            });
        }

        function updateSalesData() {
            const today = new Date().toDateString();
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            sales.today = 0;
            sales.month = 0;

            salesHistory.forEach(sale => {
                const saleDate = new Date(sale.date);
                if (saleDate.toDateString() === today) {
                    sales.today += sale.total;
                }
                if (saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear) {
                    sales.month += sale.total;
                }
            });

            // Atualizar no Firebase
            dbRef.appData.child('sales').set({
                today: sales.today,
                month: sales.month,
                goal: sales.goal
            });
        }

        function updateDashboard() {
            todaySalesElement.textContent = `R$ ${sales.today.toFixed(2)}`;
            monthSalesElement.textContent = `R$ ${sales.month.toFixed(2)}`;
            
            const goalPercentage = sales.month > 0 ? Math.min(100, (sales.month / sales.goal) * 100) : 0;
            goalPercentageElement.textContent = `${goalPercentage.toFixed(0)}%`;
            goalProgressElement.style.width = `${goalPercentage}%`;
            
            updateDashboardReceivables();
            updateTopProductsReport();
            updateTopClientsReport();
        }

        function updateDashboardReceivables() {
            dashboardReceivables.innerHTML = '';
            
            const pendingReceivables = receivables.filter(item => {
                if (item.status === 'paid') return false;
                
                const dueDate = new Date(item.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const diffTime = dueDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays <= 7 || dueDate < today;
            });
            
            if (pendingReceivables.length === 0) {
                dashboardReceivables.innerHTML = '<div class="empty-cart"><p>Nenhum recebimento pendente</p></div>';
                return;
            }
            
            pendingReceivables.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            const recentReceivables = pendingReceivables.slice(0, 3);
            
            recentReceivables.forEach(item => {
                const dueDate = new Date(item.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let statusClass = 'pending';
                let statusText = 'A Vencer';
                
                if (dueDate < today) {
                    statusClass = 'overdue';
                    statusText = 'Atrasado';
                }
                
                const formattedDate = dueDate.toLocaleDateString('pt-BR');
                
                const saleItem = document.createElement('div');
                saleItem.className = 'sale-item';
                saleItem.innerHTML = `
                    <div class="sale-info">
                        <strong>${item.client}</strong>
                        <div>Venc: ${formattedDate}</div>
                    </div>
                    <div class="sale-value ${statusClass}">
                        R$ ${item.value.toFixed(2)}
                        <div style="font-size: 12px;">${statusText}</div>
                    </div>
                `;
                dashboardReceivables.appendChild(saleItem);
            });
        }

        function updateTopProductsReport() {
            const productSales = {};
            
            salesHistory.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            id: item.id,
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    productSales[item.id].quantity += item.quantity;
                    productSales[item.id].revenue += item.price * item.quantity;
                });
            });
            
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5);
            
            topProductsSection.innerHTML = '';
            
            if (topProducts.length === 0) {
                topProductsSection.innerHTML = '<div class="report-empty"><p>Nenhuma venda registrada ainda</p></div>';
                return;
            }
            
            topProducts.forEach((product, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'report-item';
                itemElement.innerHTML = `
                    <div class="report-item-name">${index + 1}. ${product.name}</div>
                    <div class="report-item-value">${product.quantity} un</div>
                `;
                topProductsSection.appendChild(itemElement);
            });
        }

        function updateTopClientsReport() {
            const topClients = [...clients]
                .filter(client => client.totalPurchases > 0)
                .sort((a, b) => b.totalPurchases - a.totalPurchases)
                .slice(0, 5);
            
            topClientsSection.innerHTML = '';
            
            if (topClients.length === 0) {
                topClientsSection.innerHTML = '<div class="report-empty"><p>Nenhum cliente com compras registradas</p></div>';
                return;
            }
            
            topClients.forEach((client, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'report-item';
                itemElement.innerHTML = `
                    <div class="report-item-name">${index + 1}. ${client.name}</div>
                    <div class="report-item-value">R$ ${client.totalPurchases.toFixed(2)}</div>
                `;
                topClientsSection.appendChild(itemElement);
            });
        }

        function generateReport() {
            const period = reportPeriod.value;
            const type = reportType.value;
            
            detailedReport.innerHTML = '';
            
            let filteredSales = [];
            const today = new Date();
            
            switch(period) {
                case 'today':
                    filteredSales = salesHistory.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate.toDateString() === today.toDateString();
                    });
                    break;
                    
                case 'week':
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(today.getDate() - 7);
                    
                    filteredSales = salesHistory.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= oneWeekAgo;
                    });
                    break;
                    
                case 'month':
                    filteredSales = salesHistory.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate.getMonth() === today.getMonth() && 
                               saleDate.getFullYear() === today.getFullYear();
                    });
                    break;
                    
                case 'all':
                    filteredSales = [...salesHistory];
                    break;
            }
            
            if (filteredSales.length === 0) {
                detailedReport.innerHTML = '<div class="report-empty"><p>Nenhum dado encontrado para o período selecionado</p></div>';
                return;
            }
            
            if (type === 'products') {
                generateProductReport(filteredSales);
            } else if (type === 'clients') {
                generateClientReport(filteredSales);
            } else if (type === 'sales') {
                generateSalesReport(filteredSales);
            }
        }

        function generateProductReport(sales) {
            const productSales = {};
            
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            id: item.id,
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    productSales[item.id].quantity += item.quantity;
                    productSales[item.id].revenue += item.price * item.quantity;
                });
            });
            
            const productsArray = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue);
            
            const totalRevenue = productsArray.reduce((sum, product) => sum + product.revenue, 0);
            
            let reportHTML = `
                <div class="report-header">
                    <div class="report-title">Produtos Vendidos</div>
                    <div class="report-item-value">R$ ${totalRevenue.toFixed(2)}</div>
                </div>
            `;
            
            productsArray.forEach(product => {
                const percentage = ((product.revenue / totalRevenue) * 100).toFixed(1);
                
                reportHTML += `
                    <div class="report-item">
                        <div class="report-item-name">${product.name}</div>
                        <div class="report-item-value">
                            ${product.quantity} un<br>
                            <small>R$ ${product.revenue.toFixed(2)} (${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            
            detailedReport.innerHTML = reportHTML;
        }

        function generateClientReport(sales) {
            const clientSales = {};
            
            sales.forEach(sale => {
                if (sale.clientId) {
                    if (!clientSales[sale.clientId]) {
                        clientSales[sale.clientId] = {
                            id: sale.clientId,
                            name: sale.clientName,
                            count: 0,
                            revenue: 0
                        };
                    }
                    
                    clientSales[sale.clientId].count += 1;
                    clientSales[sale.clientId].revenue += sale.total;
                }
            });
            
            const clientsArray = Object.values(clientSales)
                .sort((a, b) => b.revenue - a.revenue);
                
            const totalRevenue = clientsArray.reduce((sum, client) => sum + client.revenue, 0);
            
            let reportHTML = `
                <div class="report-header">
                    <div class="report-title">Clientes</div>
                    <div class="report-item-value">R$ ${totalRevenue.toFixed(2)}</div>
                </div>
            `;
            
            clientsArray.forEach(client => {
                const percentage = ((client.revenue / totalRevenue) * 100).toFixed(1);
                
                reportHTML += `
                    <div class="report-item">
                        <div class="report-item-name">${client.name}</div>
                        <div class="report-item-value">
                            ${client.count} compras<br>
                            <small>R$ ${client.revenue.toFixed(2)} (${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            
            detailedReport.innerHTML = reportHTML;
        }

        function generateSalesReport(sales) {
            const dailySales = {};
            
            sales.forEach(sale => {
                const saleDate = new Date(sale.date).toLocaleDateString('pt-BR');
                
                if (!dailySales[saleDate]) {
                    dailySales[saleDate] = {
                        date: saleDate,
                        count: 0,
                        revenue: 0
                    };
                }
                
                dailySales[saleDate].count += 1;
                dailySales[saleDate].revenue += sale.total;
            });
            
            const dailyArray = Object.values(dailySales)
                .sort((a, b) => new Date(b.date.split('/').reverse().join('-')) - new Date(a.date.split('/').reverse().join('-')));
                
            const totalRevenue = dailyArray.reduce((sum, day) => sum + day.revenue, 0);
            const totalSales = dailyArray.reduce((sum, day) => sum + day.count, 0);
            
            let reportHTML = `
                <div class="report-header">
                    <div class="report-title">Vendas por Dia</div>
                    <div class="report-item-value">${totalSales} vendas</div>
                </div>
                <div class="report-header">
                    <div class="report-title">Total Período</div>
                    <div class="report-item-value">R$ ${totalRevenue.toFixed(2)}</div>
                </div>
            `;
            
            dailyArray.forEach(day => {
                reportHTML += `
                    <div class="report-item">
                        <div class="report-item-name">${day.date}</div>
                        <div class="report-item-value">
                            ${day.count} vendas<br>
                            <small>R$ ${day.revenue.toFixed(2)}</small>
                        </div>
                    </div>
                `;
            });
            
            detailedReport.innerHTML = reportHTML;
        }

        function updateCart() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart"><i class="fas fa-shopping-cart"></i><p>Seu carrinho está vazio</p></div>';
                cartTotal.style.display = 'none';
                finalizeSaleBtn.disabled = true;
                total = 0;
                return;
            }
            
            total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <strong>${item.name}</strong>
                        <div>R$ ${item.price.toFixed(2)}</div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-id="${item.id}">
                            <button class="quantity-btn increase" data-id="${item.id}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-price">
                        R$ ${itemTotal.toFixed(2)}
                        <div style="margin-top: 5px;">
                            <i class="fas fa-trash remove-item" data-id="${item.id}" style="color: #ff4757; cursor: pointer;"></i>
                        </div>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            totalValue.textContent = total.toFixed(2);
            cartTotal.style.display = 'block';
            finalizeSaleBtn.disabled = false;
            
            document.querySelectorAll('.increase').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const cartItem = cart.find(item => item.id === productId);
                    
                    const product = products.find(p => p.id === productId);
                    if (cartItem.quantity < product.stock) {
                        cartItem.quantity++;
                        updateCart();
                    } else {
                        alert('Estoque insuficiente para este produto!');
                    }
                });
            });
            
            document.querySelectorAll('.decrease').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const cartItem = cart.find(item => item.id === productId);
                    
                    if (cartItem.quantity > 1) {
                        cartItem.quantity--;
                        updateCart();
                    }
                });
            });
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const productId = this.getAttribute('data-id');
                    const cartItem = cart.find(item => item.id === productId);
                    const newQuantity = parseInt(this.value) || 1;
                    
                    const product = products.find(p => p.id === productId);
                    if (newQuantity <= product.stock) {
                        cartItem.quantity = newQuantity;
                        updateCart();
                    } else {
                        alert('Estoque insuficiente para este produto!');
                        this.value = cartItem.quantity;
                    }
                });
            });
            
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    cart = cart.filter(item => item.id !== productId);
                    updateCart();
                });
            });
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                clientFormTitle.textContent = 'Editar Cliente';
                clientIdInput.value = client.id;
                clientNameInput.value = client.name;
                clientEmailInput.value = client.email;
                clientPhoneInput.value = client.phone;
                clientFormCard.style.display = 'block';
            }
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                productFormTitle.textContent = 'Editar Produto';
                productIdInput.value = product.id;
                productNameInput.value = product.name;
                productCodeInput.value = product.code;
                productCostInput.value = product.cost;
                productPriceInput.value = product.price;
                productStockInput.value = product.stock;
                productFormCard.style.display = 'block';
            }
        }

        function deleteClient(clientId) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                deleteClientFromFirebase(clientId)
                    .then(() => {
                        console.log('Cliente excluído com sucesso');
                    })
                    .catch(error => {
                        console.error('Erro ao excluir cliente:', error);
                        alert('Erro ao excluir cliente. Tente novamente.');
                    });
            }
        }

        function deleteProduct(productId) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                deleteProductFromFirebase(productId)
                    .then(() => {
                        console.log('Produto excluído com sucesso');
                    })
                    .catch(error => {
                        console.error('Erro ao excluir produto:', error);
                        alert('Erro ao excluir produto. Tente novamente.');
                    });
            }
        }

        function receivePayment(receivableId) {
            if (confirm('Deseja marcar este recebível como pago?')) {
                const receivable = receivables.find(r => r.id === receivableId);
                if (receivable) {
                    receivable.status = 'paid';
                    saveReceivableToFirebase(receivable)
                        .then(() => {
                            console.log('Recebível marcado como pago');
                        })
                        .catch(error => {
                            console.error('Erro ao atualizar recebível:', error);
                            alert('Erro ao atualizar recebível. Tente novamente.');
                        });
                }
            }
        }

        function searchProducts() {
            const searchTerm = productSearchInput.value.toLowerCase();
            
            if (!searchTerm) {
                loadProducts();
                return;
            }
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.code.toLowerCase().includes(searchTerm)
            );
            
            productList.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productList.innerHTML = '<div class="empty-cart"><p>Nenhum produto encontrado</p></div>';
                return;
            }
            
            filteredProducts.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.setAttribute('data-id', product.id);
                li.setAttribute('data-name', product.name);
                li.setAttribute('data-price', product.price);
                li.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div>R$ ${product.price.toFixed(2)} | Cód: ${product.code}</div>
                    </div>
                    <div class="product-stock ${product.stock <= 5 ? 'low-stock' : ''}">Estoque: ${product.stock}</div>
                `;
                productList.appendChild(li);
            });
        }

        function searchStock() {
            const searchTerm = stockSearchInput.value.toLowerCase();
            
            if (!searchTerm) {
                loadProducts();
                return;
            }
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.code.toLowerCase().includes(searchTerm)
            );
            
            stockList.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                stockList.innerHTML = '<div class="empty-cart"><p>Nenhum produto encontrado</p></div>';
                return;
            }
            
            filteredProducts.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div>Cód: ${product.code} | R$ ${product.price.toFixed(2)}</div>
                        <div>Custo: R$ ${product.cost.toFixed(2)} | Margem: ${calculateMargin(product.cost, product.price)}%</div>
                    </div>
                    <div class="product-stock ${product.stock <= 5 ? 'low-stock' : ''}">
                        ${product.stock} unid.
                        <div class="product-actions-small">
                            <i class="fas fa-edit edit-product" data-id="${product.id}"></i>
                            <i class="fas fa-trash delete-product" data-id="${product.id}"></i>
                        </div>
                    </div>
                `;
                stockList.appendChild(li);
            });
            
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    editProduct(productId);
                });
            });
            
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    deleteProduct(productId);
                });
            });
        }

        function searchClients() {
            const searchTerm = clientSearchInput.value.toLowerCase();
            
            if (!searchTerm) {
                loadClients();
                return;
            }
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) || 
                client.email.toLowerCase().includes(searchTerm) ||
                client.phone.toLowerCase().includes(searchTerm)
            );
            
            clientList.innerHTML = '';
            
            if (filteredClients.length === 0) {
                clientList.innerHTML = '<div class="empty-cart"><p>Nenhum cliente encontrado</p></div>';
                return;
            }
            
            filteredClients.forEach(client => {
                const li = document.createElement('li');
                li.className = 'client-item';
                li.innerHTML = `
                    <div class="client-info">
                        <strong>${client.name}</strong>
                        <div>${client.email} | ${client.phone}</div>
                        <div>Total em compras: R$ ${(client.totalPurchases || 0).toFixed(2)}</div>
                    </div>
                    <div class="client-actions">
                        <i class="fas fa-edit edit-client" data-id="${client.id}"></i>
                        <i class="fas fa-trash delete-client" data-id="${client.id}"></i>
                    </div>
                `;
                clientList.appendChild(li);
            });
            
            document.querySelectorAll('.edit-client').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = this.getAttribute('data-id');
                    editClient(clientId);
                });
            });
            
            document.querySelectorAll('.delete-client').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = this.getAttribute('data-id');
                    deleteClient(clientId);
                });
            });
        }

        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('pt-BR', options);
            const formattedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            document.querySelector('.date-display').textContent = formattedDate;
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tab).classList.add('active');
                    
                    if (tab === 'reports') {
                        generateReport();
                    }
                });
            });
            
            productList.addEventListener('click', function(e) {
                const productItem = e.target.closest('.product-item');
                if (productItem) {
                    const productId = productItem.getAttribute('data-id');
                    const productName = productItem.getAttribute('data-name');
                    const productPrice = parseFloat(productItem.getAttribute('data-price'));
                    
                    const existingItem = cart.find(item => item.id === productId);
                    
                    if (existingItem) {
                        const product = products.find(p => p.id === productId);
                        if (existingItem.quantity < product.stock) {
                            existingItem.quantity++;
                        } else {
                            alert('Estoque insuficiente para este produto!');
                        }
                    } else {
                        const product = products.find(p => p.id === productId);
                        if (product.stock > 0) {
                            cart.push({
                                id: productId,
                                name: productName,
                                price: productPrice,
                                quantity: 1
                            });
                        } else {
                            alert('Produto sem estoque disponível!');
                        }
                    }
                    
                    updateCart();
                }
            });
            
            finalizeSaleBtn.addEventListener('click', function() {
                if (cart.length === 0) return;
                
                let summaryHTML = '<div class="sale-summary">';
                cart.forEach(item => {
                    summaryHTML += `
                        <div class="sale-item">
                            <div class="sale-info">${item.name} x ${item.quantity}</div>
                            <div class="sale-value">R$ ${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                    `;
                });
                summaryHTML += `
                    <div class="cart-total">
                        Total: R$ ${total.toFixed(2)}
                    </div>
                `;
                
                const clientId = clientSelect.value;
                if (clientId) {
                    const client = clients.find(c => c.id === clientId);
                    summaryHTML += `<p><strong>Cliente:</strong> ${client.name}</p>`;
                }
                
                summaryHTML += '</div>';
                
                saleSummary.innerHTML = summaryHTML;
                saleModal.style.display = 'flex';
            });
            
            cashOption.addEventListener('click', function() {
                cashOption.classList.add('active');
                termOption.classList.remove('active');
                document.querySelector('input[name="payment-method"][value="cash"]').checked = true;
                dueDateContainer.style.display = 'none';
            });
            
            termOption.addEventListener('click', function() {
                termOption.classList.add('active');
                cashOption.classList.remove('active');
                document.querySelector('input[name="payment-method"][value="term"]').checked = true;
                dueDateContainer.style.display = 'block';
            });
            
            confirmSaleBtn.addEventListener('click', function() {
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                const clientId = clientSelect.value;
                const client = clientId ? clients.find(c => c.id === clientId) : null;
                const clientName = client ? client.name : 'Cliente não identificado';

                if (paymentMethod === 'term') {
                    const dueDate = dueDateInput.value;
                    if (!dueDate) {
                        alert('Por favor, selecione uma data de vencimento para vendas a prazo.');
                        return;
                    }

                    const receivableData = {
                        client: clientName,
                        value: total,
                        dueDate: dueDate,
                        status: 'pending'
                    };

                    saveReceivableToFirebase(receivableData)
                        .catch(error => {
                            console.error('Erro ao salvar recebível:', error);
                            alert('Erro ao salvar recebível. Tente novamente.');
                        });
                }

                const saleData = {
                    date: new Date().toISOString(),
                    clientId: clientId,
                    clientName: clientName,
                    items: [...cart],
                    total: total,
                    paymentMethod: paymentMethod
                };

                saveSaleToFirebase(saleData)
                    .then(() => {
                        if (client) {
                            client.totalPurchases = (client.totalPurchases || 0) + total;
                            saveClientToFirebase(client)
                                .catch(error => {
                                    console.error('Erro ao atualizar cliente:', error);
                                });
                        }

                        const stockUpdates = [];
                        cart.forEach(cartItem => {
                            const product = products.find(p => p.id === cartItem.id);
                            if (product) {
                                const newStock = product.stock - cartItem.quantity;
                                stockUpdates.push(updateStockInFirebase(product.id, newStock));
                            }
                        });

                        Promise.all(stockUpdates)
                            .then(() => {
                                cart = [];
                                updateCart();
                                saleModal.style.display = 'none';
                                clientSelect.value = '';
                                alert('Venda finalizada com sucesso!');
                            })
                            .catch(error => {
                                console.error('Erro ao atualizar estoque:', error);
                                alert('Venda finalizada, mas houve erro ao atualizar estoque.');
                            });
                    })
                    .catch(error => {
                        console.error('Erro ao salvar venda:', error);
                        alert('Erro ao finalizar venda. Tente novamente.');
                    });
            });
            
            cancelSaleBtn.addEventListener('click', function() {
                saleModal.style.display = 'none';
            });
            
            addClientBtn.addEventListener('click', function() {
                clientFormTitle.textContent = 'Novo Cliente';
                clientIdInput.value = '';
                clientNameInput.value = '';
                clientEmailInput.value = '';
                clientPhoneInput.value = '';
                clientFormCard.style.display = 'block';
            });
            
            cancelClientBtn.addEventListener('click', function() {
                clientFormCard.style.display = 'none';
            });
            
            saveClientBtn.addEventListener('click', function() {
                const id = clientIdInput.value;
                const name = clientNameInput.value;
                const email = clientEmailInput.value;
                const phone = clientPhoneInput.value;

                if (!name) {
                    alert('Por favor, preencha o nome do cliente.');
                    return;
                }

                const clientData = { id, name, email, phone };

                saveClientToFirebase(clientData)
                    .then(() => {
                        clientFormCard.style.display = 'none';
                        alert('Cliente salvo com sucesso!');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar cliente:', error);
                        alert('Erro ao salvar cliente. Tente novamente.');
                    });
            });
            
            addProductBtn.addEventListener('click', function() {
                productFormTitle.textContent = 'Novo Produto';
                productIdInput.value = '';
                productNameInput.value = '';
                productCodeInput.value = '';
                productCostInput.value = '';
                productPriceInput.value = '';
                productStockInput.value = '';
                productFormCard.style.display = 'block';
            });
            
            cancelProductBtn.addEventListener('click', function() {
                productFormCard.style.display = 'none';
            });
            
            saveProductBtn.addEventListener('click', function() {
                const id = productIdInput.value;
                const name = productNameInput.value;
                const code = productCodeInput.value;
                const cost = parseFloat(productCostInput.value) || 0;
                const price = parseFloat(productPriceInput.value) || 0;
                const stock = parseInt(productStockInput.value) || 0;

                if (!name || !code) {
                    alert('Por favor, preencha pelo menos o nome e código do produto.');
                    return;
                }

                const productData = { id, name, code, cost, price, stock };

                saveProductToFirebase(productData)
                    .then(() => {
                        productFormCard.style.display = 'none';
                        alert('Produto salvo com sucesso!');
                    })
                    .catch(error => {
                        console.error('Erro ao salvar produto:', error);
                        alert('Erro ao salvar produto. Tente novamente.');
                    });
            });
            
            searchProductBtn.addEventListener('click', searchProducts);
            productSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchProducts();
            });
            
            stockSearchBtn.addEventListener('click', searchStock);
            stockSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchStock();
            });
            
            clientSearchBtn.addEventListener('click', searchClients);
            clientSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchClients();
            });
        }

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Iniciando Business Control...');
            loadFirebaseData();
            setupEventListeners();
            updateDateTime();
            
            const today = new Date().toISOString().split('T')[0];
            dueDateInput.setAttribute('min', today);
            dueDateInput.value = today;
            
            reportPeriod.addEventListener('change', generateReport);
            reportType.addEventListener('change', generateReport);
            
            console.log('✅ Business Control iniciado com sucesso!');
        });
    </script>
</body>
</html>
