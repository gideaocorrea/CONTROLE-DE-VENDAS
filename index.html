<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Control - PDV Completo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Adicionando Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* Seus estilos CSS existentes permanecem os mesmos */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* ... (todos os outros estilos permanecem exatamente como estão) ... */
        
        .report-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .report-filter select {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        /* Adicionando um indicador de carregamento */
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #2575fc;
        }
        
        .loading i {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Seu HTML existente permanece exatamente o mesmo -->
        <div class="header">
            <div class="user-actions">
                <i class="fas fa-bell"></i>
                <i class="fas fa-cog"></i>
            </div>
            <h2>Business Control</h2>
            <div class="date-display">Segunda-feira, 25 de Setembro de 2023</div>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div class="tab-content" id="dashboard">
                <!-- ... conteúdo do dashboard ... -->
            </div>
            
            <!-- PDV Tab -->
            <div class="tab-content active" id="pdv">
                <!-- ... conteúdo do PDV ... -->
            </div>
            
            <!-- Estoque Tab -->
            <div class="tab-content" id="stock">
                <!-- ... conteúdo do estoque ... -->
            </div>
            
            <!-- Clientes Tab -->
            <div class="tab-content" id="clients">
                <!-- ... conteúdo dos clientes ... -->
            </div>
            
            <!-- Receivables Tab -->
            <div class="tab-content" id="receivables">
                <!-- ... conteúdo dos recebíveis ... -->
            </div>
            
            <!-- Relatórios Tab -->
            <div class="tab-content" id="reports">
                <!-- ... conteúdo dos relatórios ... -->
            </div>
        </div>
        
        <div class="nav">
            <!-- ... navegação ... -->
        </div>
    </div>

    <!-- Modal de Finalização de Venda -->
    <div class="modal" id="sale-modal">
        <!-- ... conteúdo do modal ... -->
    </div>

    <!-- Adicionando indicador de carregamento -->
    <div class="loading" id="loading-indicator">
        <i class="fas fa-spinner"></i> Conectando ao banco de dados...
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB6w3Y9cPp0Y2m9Xx4j8p3K2vQ5N7R8T9U",
            authDomain: "controle-de-vendas-bf26d.firebaseapp.com",
            databaseURL: "https://controle-de-vendas-bf26d-default-rtdb.firebaseio.com",
            projectId: "controle-de-vendas-bf26d",
            storageBucket: "controle-de-vendas-bf26d.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnopqrstuv"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Dados da aplicação - agora serão carregados do Firebase
        let cart = [];
        let total = 0;
        let clients = [];
        let products = [];
        let salesHistory = [];
        let receivables = [];
        
        // Dados de vendas para dashboard
        let sales = {
            today: 0,
            month: 0,
            goal: 30000 // Meta mensal de R$ 30.000
        };
        
        // Elementos do DOM (mantidos os mesmos)
        const productList = document.getElementById('product-list');
        const stockList = document.getElementById('stock-list');
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const totalValue = document.getElementById('total-value');
        const clientSelect = document.getElementById('client-select');
        const finalizeSaleBtn = document.getElementById('finalize-sale');
        const saleModal = document.getElementById('sale-modal');
        const saleSummary = document.getElementById('sale-summary');
        const cancelSaleBtn = document.getElementById('cancel-sale');
        const confirmSaleBtn = document.getElementById('confirm-sale');
        const clientList = document.getElementById('client-list');
        const addClientBtn = document.getElementById('add-client-btn');
        const clientFormCard = document.getElementById('client-form-card');
        const clientFormTitle = document.getElementById('client-form-title');
        const cancelClientBtn = document.getElementById('cancel-client');
        const saveClientBtn = document.getElementById('save-client');
        const clientIdInput = document.getElementById('client-id');
        const clientNameInput = document.getElementById('client-name');
        const clientEmailInput = document.getElementById('client-email');
        const clientPhoneInput = document.getElementById('client-phone');
        const receivablesList = document.getElementById('receivables-list');
        const cashOption = document.getElementById('cash-option');
        const termOption = document.getElementById('term-option');
        const dueDateContainer = document.getElementById('due-date-container');
        const dueDateInput = document.getElementById('due-date');
        const addProductBtn = document.getElementById('add-product-btn');
        const productFormCard = document.getElementById('product-form-card');
        const productFormTitle = document.getElementById('product-form-title');
        const cancelProductBtn = document.getElementById('cancel-product');
        const saveProductBtn = document.getElementById('save-product');
        const productIdInput = document.getElementById('product-id');
        const productNameInput = document.getElementById('product-name');
        const productCodeInput = document.getElementById('product-code');
        const productCostInput = document.getElementById('product-cost');
        const productPriceInput = document.getElementById('product-price');
        const productStockInput = document.getElementById('product-stock');
        const productSearchInput = document.getElementById('product-search');
        const searchProductBtn = document.getElementById('search-product-btn');
        const stockSearchInput = document.getElementById('stock-search');
        const stockSearchBtn = document.getElementById('stock-search-btn');
        const clientSearchInput = document.getElementById('client-search');
        const clientSearchBtn = document.getElementById('client-search-btn');
        const todaySalesElement = document.getElementById('today-sales');
        const monthSalesElement = document.getElementById('month-sales');
        const goalPercentageElement = document.getElementById('goal-percentage');
        const goalProgressElement = document.getElementById('goal-progress');
        const dashboardReceivables = document.getElementById('dashboard-receivables');
        const toReceiveValueElement = document.getElementById('to-receive-value');
        const overdueValueElement = document.getElementById('overdue-value');
        const totalReceivablesElement = document.getElementById('total-receivables');
        const topProductsSection = document.getElementById('top-products-section');
        const topClientsSection = document.getElementById('top-clients-section');
        const reportPeriod = document.getElementById('report-period');
        const reportType = document.getElementById('report-type');
        const detailedReport = document.getElementById('detailed-report');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Funções para interagir com o Firebase
        function showLoading() {
            loadingIndicator.style.display = 'block';
        }
        
        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }
        
        // Carregar dados do Firebase
        function loadDataFromFirebase() {
            showLoading();
            
            // Carregar produtos
            database.ref('products').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    products = Object.values(data);
                } else {
                    products = [];
                }
                loadProducts();
            });
            
            // Carregar clientes
            database.ref('clients').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    clients = Object.values(data);
                } else {
                    // Dados iniciais de exemplo se não houver dados
                    clients = [
                        { id: 1, name: "João Silva", email: "joao@email.com", phone: "(11) 99999-9999", totalPurchases: 0 },
                        { id: 2, name: "Maria Santos", email: "maria@email.com", phone: "(11) 98888-8888", totalPurchases: 0 },
                        { id: 3, name: "Empresa ABC", email: "contato@empresa.com", phone: "(11) 97777-7777", totalPurchases: 0 }
                    ];
                    // Salvar clientes iniciais no Firebase
                    saveClientsToFirebase();
                }
                loadClients();
            });
            
            // Carregar histórico de vendas
            database.ref('salesHistory').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    salesHistory = Object.values(data);
                } else {
                    salesHistory = [];
                }
                updateDashboard();
            });
            
            // Carregar recebíveis
            database.ref('receivables').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    receivables = Object.values(data);
                } else {
                    receivables = [];
                }
                loadReceivables();
                hideLoading();
            });
            
            // Calcular vendas do dia e do mês
            calculateSales();
        }
        
        // Salvar produtos no Firebase
        function saveProductsToFirebase() {
            const productsObj = {};
            products.forEach(product => {
                productsObj[product.id] = product;
            });
            database.ref('products').set(productsObj);
        }
        
        // Salvar clientes no Firebase
        function saveClientsToFirebase() {
            const clientsObj = {};
            clients.forEach(client => {
                clientsObj[client.id] = client;
            });
            database.ref('clients').set(clientsObj);
        }
        
        // Salvar histórico de vendas no Firebase
        function saveSalesHistoryToFirebase() {
            const salesHistoryObj = {};
            salesHistory.forEach(sale => {
                salesHistoryObj[sale.id] = sale;
            });
            database.ref('salesHistory').set(salesHistoryObj);
        }
        
        // Salvar recebíveis no Firebase
        function saveReceivablesToFirebase() {
            const receivablesObj = {};
            receivables.forEach(receivable => {
                receivablesObj[receivable.id] = receivable;
            });
            database.ref('receivables').set(receivablesObj);
        }
        
        // Calcular vendas do dia e do mês
        function calculateSales() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            const month = today.getMonth();
            const year = today.getFullYear();
            
            sales.today = 0;
            sales.month = 0;
            
            salesHistory.forEach(sale => {
                const saleDate = new Date(sale.date);
                const saleDateString = saleDate.toISOString().split('T')[0];
                
                if (saleDateString === todayString) {
                    sales.today += sale.total;
                }
                
                if (saleDate.getMonth() === month && saleDate.getFullYear() === year) {
                    sales.month += sale.total;
                }
            });
            
            updateDashboard();
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar dados do Firebase
            loadDataFromFirebase();
            
            // Configurar data mínima para o datepicker (hoje)
            const today = new Date().toISOString().split('T')[0];
            dueDateInput.setAttribute('min', today);
            
            // Adicionar event listeners para os relatórios
            reportPeriod.addEventListener('change', generateReport);
            reportType.addEventListener('change', generateReport);
            
            setupEventListeners();
            updateDateTime();
        });
        
        // As funções restantes permanecem as mesmas, apenas atualizando as que salvam dados
        // para também salvar no Firebase
        
        // Carregar clientes nos selects e listas
        function loadClients() {
            // Limpar selects e listas
            clientSelect.innerHTML = '<option value="">Selecionar cliente...</option>';
            clientList.innerHTML = '';
            
            // Adicionar clientes ao select
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });
            
            // Adicionar clientes à lista
            clients.forEach(client => {
                const li = document.createElement('li');
                li.className = 'client-item';
                li.innerHTML = `
                    <div class="client-info">
                        <strong>${client.name}</strong>
                        <div>${client.email} | ${client.phone}</div>
                        <div>Total em compras: R$ ${client.totalPurchases.toFixed(2)}</div>
                    </div>
                    <div class="client-actions">
                        <i class="fas fa-edit edit-client" data-id="${client.id}"></i>
                        <i class="fas fa-trash delete-client" data-id="${client.id}"></i>
                    </div>
                `;
                clientList.appendChild(li);
            });
            
            // Adicionar event listeners para editar e excluir
            document.querySelectorAll('.edit-client').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = this.getAttribute('data-id');
                    editClient(clientId);
                });
            });
            
            document.querySelectorAll('.delete-client').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = this.getAttribute('data-id');
                    deleteClient(clientId);
                });
            });
        }
        
        // Carregar produtos
        function loadProducts() {
            productList.innerHTML = '';
            stockList.innerHTML = '';
            
            if (products.length === 0) {
                productList.innerHTML = '<div class="empty-cart"><p>Nenhum produto cadastrado</p></div>';
                stockList.innerHTML = '<div class="empty-cart"><p>Nenhum produto cadastrado</p></div>';
                return;
            }
            
            // Adicionar produtos à lista do PDV
            products.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.setAttribute('data-id', product.id);
                li.setAttribute('data-name', product.name);
                li.setAttribute('data-price', product.price);
                li.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div>R$ ${product.price.toFixed(2)} | Cód: ${product.code}</div>
                    </div>
                    <div class="product-stock ${product.stock <= 5 ? 'low-stock' : ''}">Estoque: ${product.stock}</div>
                `;
                productList.appendChild(li);
            });
            
            // Adicionar produtos à lista de estoque
            products.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div>Cód: ${product.code} | R$ ${product.price.toFixed(2)}</div>
                        <div>Custo: R$ ${product.cost.toFixed(2)} | Margem: ${calculateMargin(product.cost, product.price)}%</div>
                    </div>
                    <div class="product-stock ${product.stock <= 5 ? 'low-stock' : ''}">
                        ${product.stock} unid.
                        <div class="product-actions-small">
                            <i class="fas fa-edit edit-product" data-id="${product.id}"></i>
                            <i class="fas fa-trash delete-product" data-id="${product.id}"></i>
                        </div>
                    </div>
                `;
                stockList.appendChild(li);
            });
            
            // Adicionar event listeners para editar e excluir produtos
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    editProduct(productId);
                });
            });
            
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    deleteProduct(productId);
                });
            });
        }
        
        // Calcular margem de lucro
        function calculateMargin(cost, price) {
            if (cost === 0) return 100;
            return (((price - cost) / cost) * 100).toFixed(2);
        }
        
        // Carregar vendas a receber
        function loadReceivables() {
            receivablesList.innerHTML = '';
            
            if (receivables.length === 0) {
                receivablesList.innerHTML = '<div class="empty-cart"><p>Nenhuma venda a receber</p></div>';
                toReceiveValueElement.textContent = 'R$ 0,00';
                overdueValueElement.textContent = 'R$ 0,00';
                totalReceivablesElement.textContent = 'R$ 0,00';
                return;
            }
            
            let toReceiveTotal = 0;
            let overdueTotal = 0;
            let totalReceivables = 0;
            
            receivables.forEach(item => {
                // Verificar status
                const today = new Date();
                const dueDate = new Date(item.dueDate);
                let status = 'pending';
                let statusClass = 'pending';
                
                if (item.status === 'paid') {
                    status = 'paid';
                    statusClass = 'paid';
                } else if (dueDate < today) {
                    status = 'overdue';
                    statusClass = 'overdue';
                    overdueTotal += item.value;
                } else {
                    toReceiveTotal += item.value;
                }
                
                totalReceivables += item.value;
                
                // Formatar data
                const formattedDate = dueDate.toLocaleDateString('pt-BR');
                
                const li = document.createElement('li');
                li.className = 'client-item';
                li.innerHTML = `
                    <div class="client-info">
                        <strong>${item.client}</strong>
                        <div>Vencimento: ${formattedDate}</div>
                        ${status !== 'paid' ? `
                        <div class="receivable-actions">
                            <button class="btn btn-small receive-payment" data-id="${item.id}">Receber</button>
                        </div>
                        ` : ''}
                    </div>
                    <div class="client-value ${statusClass}">R$ ${item.value.toFixed(2)}</div>
                `;
                receivablesList.appendChild(li);
            });
            
            // Atualizar totais
            toReceiveValueElement.textContent = `R$ ${toReceiveTotal.toFixed(2)}`;
            overdueValueElement.textContent = `R$ ${overdueTotal.toFixed(2)}`;
            totalReceivablesElement.textContent = `R$ ${totalReceivables.toFixed(2)}`;
            
            // Adicionar event listeners para o botão de receber
            document.querySelectorAll('.receive-payment').forEach(btn => {
                btn.addEventListener('click', function() {
                    const receivableId = this.getAttribute('data-id');
                    receivePayment(receivableId);
                });
            });
        }
        
        // Atualizar dashboard
        function updateDashboard() {
            // Atualizar vendas
            todaySalesElement.textContent = `R$ ${sales.today.toFixed(2)}`;
            monthSalesElement.textContent = `R$ ${sales.month.toFixed(2)}`;
            
            // Calcular porcentagem da meta
            const goalPercentage = sales.month > 0 ? Math.min(100, (sales.month / sales.goal) * 100) : 0;
            goalPercentageElement.textContent = `${goalPercentage.toFixed(0)}%`;
            goalProgressElement.style.width = `${goalPercentage}%`;
            
            // Atualizar recebíveis no dashboard
            updateDashboardReceivables();
            
            // Atualizar relatórios
            updateTopProductsReport();
            updateTopClientsReport();
        }
        
        // Atualizar recebíveis no dashboard
        function updateDashboardReceivables() {
            dashboardReceivables.innerHTML = '';
            
            // Filtrar apenas recebíveis pendentes e vencidos
            const pendingReceivables = receivables.filter(item => {
                if (item.status === 'paid') return false;
                
                const dueDate = new Date(item.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Mostrar apenas os que vencem nos próximos 7 dias ou estão atrasados
                const diffTime = dueDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays <= 7 || dueDate < today;
            });
            
            if (pendingReceivables.length === 0) {
                dashboardReceivables.innerHTML = '<div class="empty-cart"><p>Nenhum recebimento pendente</p></div>';
                return;
            }
            
            // Ordenar por data de vencimento (mais próximos primeiro)
            pendingReceivables.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            // Mostrar apenas os 3 mais próximos
            const recentReceivables = pendingReceivables.slice(0, 3);
            
            recentReceivables.forEach(item => {
                const dueDate = new Date(item.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                let statusClass = 'pending';
                let statusText = 'A Vencer';
                
                if (dueDate < today) {
                    statusClass = 'overdue';
                    statusText = 'Atrasado';
                }
                
                const formattedDate = dueDate.toLocaleDateString('pt-BR');
                
                const saleItem = document.createElement('div');
                saleItem.className = 'sale-item';
                saleItem.innerHTML = `
                    <div class="sale-info">
                        <strong>${item.client}</strong>
                        <div>Venc: ${formattedDate}</div>
                    </div>
                    <div class="sale-value ${statusClass}">
                        R$ ${item.value.toFixed(2)}
                        <div style="font-size: 12px;">${statusText}</div>
                    </div>
                `;
                dashboardReceivables.appendChild(saleItem);
            });
        }
        
        // Atualizar relatório de produtos mais vendidos
        function updateTopProductsReport() {
            // Calcular totais de vendas por produto
            const productSales = {};
            
            salesHistory.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            id: item.id,
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    productSales[item.id].quantity += item.quantity;
                    productSales[item.id].revenue += item.price * item.quantity;
                });
            });
            
            // Converter para array e ordenar por quantidade vendida
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 5); // Top 5 produtos
            
            // Atualizar a interface
            topProductsSection.innerHTML = '';
            
            if (topProducts.length === 0) {
                topProductsSection.innerHTML = '<div class="report-empty"><p>Nenhuma venda registrada ainda</p></div>';
                return;
            }
            
            topProducts.forEach((product, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'report-item';
                itemElement.innerHTML = `
                    <div class="report-item-name">${index + 1}. ${product.name}</div>
                    <div class="report-item-value">${product.quantity} un</div>
                `;
                topProductsSection.appendChild(itemElement);
            });
        }
        
        // Atualizar relatório de melhores clientes
        function updateTopClientsReport() {
            // Ordenar clientes por valor total de compras
            const topClients = [...clients]
                .filter(client => client.totalPurchases > 0)
                .sort((a, b) => b.totalPurchases - a.totalPurchases)
                .slice(0, 5); // Top 5 clientes
            
            // Atualizar a interface
            topClientsSection.innerHTML = '';
            
            if (topClients.length === 0) {
                topClientsSection.innerHTML = '<div class="report-empty"><p>Nenhum cliente com compras registradas</p></div>';
                return;
            }
            
            topClients.forEach((client, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'report-item';
                itemElement.innerHTML = `
                    <div class="report-item-name">${index + 1}. ${client.name}</div>
                    <div class="report-item-value">R$ ${client.totalPurchases.toFixed(2)}</div>
                `;
                topClientsSection.appendChild(itemElement);
            });
        }
        
        // Gerar relatório detalhado
        function generateReport() {
            const period = reportPeriod.value;
            const type = reportType.value;
            
            detailedReport.innerHTML = '';
            
            // Filtrar vendas pelo período selecionado
            let filteredSales = [];
            const today = new Date();
            
            switch(period) {
                case 'today':
                    filteredSales = salesHistory.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate.toDateString() === today.toDateString();
                    });
                    break;
                    
                case 'week':
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(today.getDate() - 7);
                    
                    filteredSales = salesHistory.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate >= oneWeekAgo;
                    });
                    break;
                    
                case 'month':
                    filteredSales = salesHistory.filter(sale => {
                        const saleDate = new Date(sale.date);
                        return saleDate.getMonth() === today.getMonth() && 
                               saleDate.getFullYear() === today.getFullYear();
                    });
                    break;
                    
                case 'all':
                    filteredSales = [...salesHistory];
                    break;
            }
            
            if (filteredSales.length === 0) {
                detailedReport.innerHTML = '<div class="report-empty"><p>Nenhum dado encontrado para o período selecionado</p></div>';
                return;
            }
            
            // Gerar relatório com base no tipo selecionado
            if (type === 'products') {
                generateProductReport(filteredSales);
            } else if (type === 'clients') {
                generateClientReport(filteredSales);
            } else if (type === 'sales') {
                generateSalesReport(filteredSales);
            }
        }
        
        // Gerar relatório de produtos
        function generateProductReport(sales) {
            const productSales = {};
            
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!productSales[item.id]) {
                        productSales[item.id] = {
                            id: item.id,
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    productSales[item.id].quantity += item.quantity;
                    productSales[item.id].revenue += item.price * item.quantity;
                });
            });
            
            const productsArray = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue);
            
            const totalRevenue = productsArray.reduce((sum, product) => sum + product.revenue, 0);
            
            let reportHTML = `
                <div class="report-header">
                    <div class="report-title">Produtos Vendidos</div>
                    <div class="report-item-value">R$ ${totalRevenue.toFixed(2)}</div>
                </div>
            `;
            
            productsArray.forEach(product => {
                const percentage = ((product.revenue / totalRevenue) * 100).toFixed(1);
                
                reportHTML += `
                    <div class="report-item">
                        <div class="report-item-name">${product.name}</div>
                        <div class="report-item-value">
                            ${product.quantity} un<br>
                            <small>R$ ${product.revenue.toFixed(2)} (${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            
            detailedReport.innerHTML = reportHTML;
        }
        
        // Gerar relatório de clientes
        function generateClientReport(sales) {
            const clientSales = {};
            
            sales.forEach(sale => {
                if (sale.clientId) {
                    if (!clientSales[sale.clientId]) {
                        clientSales[sale.clientId] = {
                            id: sale.clientId,
                            name: sale.clientName,
                            count: 0,
                            revenue: 0
                        };
                    }
                    
                    clientSales[sale.clientId].count += 1;
                    clientSales[sale.clientId].revenue += sale.total;
                }
            });
            
            const clientsArray = Object.values(clientSales)
                .sort((a, b) => b.revenue - a.revenue);
                
            const totalRevenue = clientsArray.reduce((sum, client) => sum + client.revenue, 0);
            
            let reportHTML = `
                <div class="report-header">
                    <div class="report-title">Clientes</div>
                    <div class="report-item-value">R$ ${totalRevenue.toFixed(2)}</div>
                </div>
            `;
            
            clientsArray.forEach(client => {
                const percentage = ((client.revenue / totalRevenue) * 100).toFixed(1);
                
                reportHTML += `
                    <div class="report-item">
                        <div class="report-item-name">${client.name}</div>
                        <div class="report-item-value">
                            ${client.count} compras<br>
                            <small>R$ ${client.revenue.toFixed(2)} (${percentage}%)</small>
                        </div>
                    </div>
                `;
            });
            
            detailedReport.innerHTML = reportHTML;
        }
        
        // Gerar relatório de vendas
        function generateSalesReport(sales) {
            const dailySales = {};
            
            sales.forEach(sale => {
                const saleDate = new Date(sale.date).toLocaleDateString('pt-BR');
                
                if (!dailySales[saleDate]) {
                    dailySales[saleDate] = {
                        date: saleDate,
                        count: 0,
                        revenue: 0
                    };
                }
                
                dailySales[saleDate].count += 1;
                dailySales[saleDate].revenue += sale.total;
            });
            
            const dailyArray = Object.values(dailySales)
                .sort((a, b) => new Date(b.date.split('/').reverse().join('-')) - new Date(a.date.split('/').reverse().join('-')));
                
            const totalRevenue = dailyArray.reduce((sum, day) => sum + day.revenue, 0);
            const totalSales = dailyArray.reduce((sum, day) => sum + day.count, 0);
            
            let reportHTML = `
                <div class="report-header">
                    <div class="report-title">Vendas por Dia</div>
                    <div class="report-item-value">${totalSales} vendas</div>
                </div>
                <div class="report-header">
                    <div class="report-title">Total Período</div>
                    <div class="report-item-value">R$ ${totalRevenue.toFixed(2)}</div>
                </div>
            `;
            
            dailyArray.forEach(day => {
                reportHTML += `
                    <div class="report-item">
                        <div class="report-item-name">${day.date}</div>
                        <div class="report-item-value">
                            ${day.count} vendas<br>
                            <small>R$ ${day.revenue.toFixed(2)}</small>
                        </div>
                    </div>
                `;
            });
            
            detailedReport.innerHTML = reportHTML;
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Navegação por abas
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    
                    // Ativar aba clicada
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Mostrar conteúdo correspondente
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tab).classList.add('active');
                    
                    // Se for a aba de relatórios, gerar o relatório
                    if (tab === 'reports') {
                        generateReport();
                    }
                });
            });
            
            // Adicionar produto ao carrinho
            productList.addEventListener('click', function(e) {
                const productItem = e.target.closest('.product-item');
                if (productItem) {
                    const productId = parseInt(productItem.getAttribute('data-id'));
                    const productName = productItem.getAttribute('data-name');
                    const productPrice = parseFloat(productItem.getAttribute('data-price'));
                    
                    // Verificar se o produto já está no carrinho
                    const existingItem = cart.find(item => item.id === productId);
                    
                    if (existingItem) {
                        // Verificar se há estoque disponível
                        const product = products.find(p => p.id === productId);
                        if (existingItem.quantity < product.stock) {
                            existingItem.quantity++;
                        } else {
                            alert('Estoque insuficiente para este produto!');
                        }
                    } else {
                        // Verificar se há estoque disponível
                        const product = products.find(p => p.id === productId);
                        if (product.stock > 0) {
                            cart.push({
                                id: productId,
                                name: productName,
                                price: productPrice,
                                quantity: 1
                            });
                        } else {
                            alert('Produto sem estoque disponível!');
                        }
                    }
                    
                    updateCart();
                }
            });
            
            // Finalizar venda
            finalizeSaleBtn.addEventListener('click', function() {
                if (cart.length === 0) return;
                
                // Criar resumo da venda
                let summaryHTML = '<div class="sale-summary">';
                cart.forEach(item => {
                    summaryHTML += `
                        <div class="sale-item">
                            <div class="sale-info">${item.name} x ${item.quantity}</div>
                            <div class="sale-value">R$ ${(item.price * item.quantity).toFixed(2)}</div>
                        </div>
                    `;
                });
                summaryHTML += `
                    <div class="cart-total">
                        Total: R$ ${total.toFixed(2)}
                    </div>
                `;
                
                // Adicionar informações do cliente se selecionado
                const clientId = clientSelect.value;
                if (clientId) {
                    const client = clients.find(c => c.id === parseInt(clientId));
                    summaryHTML += `<p><strong>Cliente:</strong> ${client.name}</p>`;
                }
                
                summaryHTML += '</div>';
                
                saleSummary.innerHTML = summaryHTML;
                
                // Mostrar modal
                saleModal.style.display = 'flex';
            });
            
            // Opções de pagamento
            cashOption.addEventListener('click', function() {
                cashOption.classList.add('active');
                termOption.classList.remove('active');
                document.querySelector('input[name="payment-method"][value="cash"]').checked = true;
                dueDateContainer.style.display = 'none';
            });
            
            termOption.addEventListener('click', function() {
                termOption.classList.add('active');
                cashOption.classList.remove('active');
                document.querySelector('input[name="payment-method"][value="term"]').checked = true;
                dueDateContainer.style.display = 'block';
            });
            
            // Confirmar venda
            confirmSaleBtn.addEventListener('click', function() {
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                const clientId = clientSelect.value;
                const clientName = clientId ? clients.find(c => c.id === parseInt(clientId)).name : 'Cliente não identificado';
                
                if (paymentMethod === 'term') {
                    const dueDate = dueDateInput.value;
                    if (!dueDate) {
                        alert('Por favor, selecione uma data de vencimento para vendas a prazo.');
                        return;
                    }
                    
                    // Adicionar à lista de recebíveis
                    const receivableId = receivables.length > 0 ? Math.max(...receivables.map(r => r.id)) + 1 : 1;
                    receivables.push({
                        id: receivableId,
                        client: clientName,
                        value: total,
                        dueDate: dueDate,
                        status: 'pending'
                    });
                    
                    // Salvar recebíveis no Firebase
                    saveReceivablesToFirebase();
                }
                
                // Registrar venda no histórico
                const saleId = salesHistory.length > 0 ? Math.max(...salesHistory.map(s => s.id)) + 1 : 1;
                const saleDate = new Date().toISOString();
                
                salesHistory.push({
                    id: saleId,
                    date: saleDate,
                    clientId: clientId ? parseInt(clientId) : null,
                    clientName: clientName,
                    items: [...cart],
                    total: total,
                    paymentMethod: paymentMethod
                });
                
                // Salvar histórico de vendas no Firebase
                saveSalesHistoryToFirebase();
                
                // Atualizar total de compras do cliente
                if (clientId) {
                    const client = clients.find(c => c.id === parseInt(clientId));
                    if (client) {
                        client.totalPurchases += total;
                        // Salvar clientes atualizados no Firebase
                        saveClientsToFirebase();
                    }
                }
                
                // Atualizar estoque
                updateStockAfterSale();
                
                // Atualizar vendas
                const saleValue = total;
                sales.today += saleValue;
                sales.month += saleValue;
                
                // Limpar carrinho
                cart = [];
                updateCart();
                
                // Fechar modal
                saleModal.style.display = 'none';
                
                // Recarregar dados
                loadProducts();
                loadReceivables();
                updateDashboard();
                
                // Resetar seleção de cliente
                clientSelect.value = '';
                
                alert('Venda finalizada com sucesso!');
            });
            
            // Cancelar venda
            cancelSaleBtn.addEventListener('click', function() {
                saleModal.style.display = 'none';
            });
            
            // Clientes - Adicionar/Editar
            addClientBtn.addEventListener('click', function() {
                clientFormTitle.textContent = 'Novo Cliente';
                clientIdInput.value = '';
                clientNameInput.value = '';
                clientEmailInput.value = '';
                clientPhoneInput.value = '';
                clientFormCard.style.display = 'block';
            });
            
            cancelClientBtn.addEventListener('click', function() {
                clientFormCard.style.display = 'none';
            });
            
            saveClientBtn.addEventListener('click', function() {
                const id = clientIdInput.value;
                const name = clientNameInput.value;
                const email = clientEmailInput.value;
                const phone = clientPhoneInput.value;
                
                if (!name) {
                    alert('Por favor, preencha o nome do cliente.');
                    return;
                }
                
                if (id) {
                    // Editar cliente existente
                    const index = clients.findIndex(c => c.id === parseInt(id));
                    if (index !== -1) {
                        clients[index] = { 
                            id: parseInt(id), 
                            name, 
                            email, 
                            phone, 
                            totalPurchases: clients[index].totalPurchases 
                        };
                    }
                } else {
                    // Adicionar novo cliente
                    const newId = clients.length > 0 ? Math.max(...clients.map(c => c.id)) + 1 : 1;
                    clients.push({ id: newId, name, email, phone, totalPurchases: 0 });
                }
                
                // Salvar clientes no Firebase
                saveClientsToFirebase();
                
                loadClients();
                clientFormCard.style.display = 'none';
            });
            
            // Produtos - Adicionar/Editar
            addProductBtn.addEventListener('click', function() {
                productFormTitle.textContent = 'Novo Produto';
                productIdInput.value = '';
                productNameInput.value = '';
                productCodeInput.value = '';
                productCostInput.value = '';
                productPriceInput.value = '';
                productStockInput.value = '';
                productFormCard.style.display = 'block';
            });
            
            cancelProductBtn.addEventListener('click', function() {
                productFormCard.style.display = 'none';
            });
            
            saveProductBtn.addEventListener('click', function() {
                const id = productIdInput.value;
                const name = productNameInput.value;
                const code = productCodeInput.value;
                const cost = parseFloat(productCostInput.value) || 0;
                const price = parseFloat(productPriceInput.value) || 0;
                const stock = parseInt(productStockInput.value) || 0;
                
                if (!name || !code) {
                    alert('Por favor, preencha pelo menos o nome e código do produto.');
                    return;
                }
                
                if (id) {
                    // Editar produto existente
                    const index = products.findIndex(p => p.id === parseInt(id));
                    if (index !== -1) {
                        products[index] = { id: parseInt(id), name, code, cost, price, stock };
                    }
                } else {
                    // Adicionar novo produto
                    const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                    products.push({ id: newId, name, code, cost, price, stock });
                }
                
                // Salvar produtos no Firebase
                saveProductsToFirebase();
                
                loadProducts();
                productFormCard.style.display = 'none';
            });
            
            // Buscar produtos
            searchProductBtn.addEventListener('click', searchProducts);
            productSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchProducts();
            });
            
            // Buscar estoque
            stockSearchBtn.addEventListener('click', searchStock);
            stockSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchStock();
            });
            
            // Buscar clientes
            clientSearchBtn.addEventListener('click', searchClients);
            clientSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchClients();
            });
        }
        
        // Atualizar carrinho
        function updateCart() {
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart"><i class="fas fa-shopping-cart"></i><p>Seu carrinho está vazio</p></div>';
                cartTotal.style.display = 'none';
                finalizeSaleBtn.disabled = true;
                total = 0;
                return;
            }
            
            total = 0;
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <strong>${item.name}</strong>
                        <div>R$ ${item.price.toFixed(2)}</div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-id="${item.id}">
                            <button class="quantity-btn increase" data-id="${item.id}">+</button>
                        </div>
                    </div>
                    <div class="cart-item-price">
                        R$ ${itemTotal.toFixed(2)}
                        <div style="margin-top: 5px;">
                            <i class="fas fa-trash remove-item" data-id="${item.id}" style="color: #ff4757; cursor: pointer;"></i>
                        </div>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            totalValue.textContent = total.toFixed(2);
            cartTotal.style.display = 'block';
            finalizeSaleBtn.disabled = false;
            
            // Adicionar event listeners para os botões de quantidade
            document.querySelectorAll('.increase').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const cartItem = cart.find(item => item.id === productId);
                    
                    // Verificar se há estoque disponível
                    const product = products.find(p => p.id === productId);
                    if (cartItem.quantity < product.stock) {
                        cartItem.quantity++;
                        updateCart();
                    } else {
                        alert('Estoque insuficiente para este produto!');
                    }
                });
            });
            
            document.querySelectorAll('.decrease').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const cartItem = cart.find(item => item.id === productId);
                    
                    if (cartItem.quantity > 1) {
                        cartItem.quantity--;
                        updateCart();
                    }
                });
            });
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('change', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    const cartItem = cart.find(item => item.id === productId);
                    const newQuantity = parseInt(this.value) || 1;
                    
                    // Verificar se há estoque disponível
                    const product = products.find(p => p.id === productId);
                    if (newQuantity <= product.stock) {
                        cartItem.quantity = newQuantity;
                        updateCart();
                    } else {
                        alert('Estoque insuficiente para este produto!');
                        this.value = cartItem.quantity;
                    }
                });
            });
            
            document.querySelectorAll('.remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    cart = cart.filter(item => item.id !== productId);
                    updateCart();
                });
            });
        }
        
        // Atualizar estoque após venda
        function updateStockAfterSale() {
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.stock -= cartItem.quantity;
                    if (product.stock < 0) product.stock = 0;
                }
            });
            
            // Salvar produtos atualizados no Firebase
            saveProductsToFirebase();
        }
        
        // Editar cliente
        function editClient(clientId) {
            const client = clients.find(c => c.id === parseInt(clientId));
            if (client) {
                clientFormTitle.textContent = 'Editar Cliente';
                clientIdInput.value = client.id;
                clientNameInput.value = client.name;
                clientEmailInput.value = client.email;
                clientPhoneInput.value = client.phone;
                clientFormCard.style.display = 'block';
            }
        }
        
        // Excluir cliente
        function deleteClient(clientId) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                clients = clients.filter(c => c.id !== parseInt(clientId));
                // Salvar clientes atualizados no Firebase
                saveClientsToFirebase();
                loadClients();
            }
        }
        
        // Editar produto
        function editProduct(productId) {
            const product = products.find(p => p.id === parseInt(productId));
            if (product) {
                productFormTitle.textContent = 'Editar Produto';
                productIdInput.value = product.id;
                productNameInput.value = product.name;
                productCodeInput.value = product.code;
                productCostInput.value = product.cost;
                productPriceInput.value = product.price;
                productStockInput.value = product.stock;
                productFormCard.style.display = 'block';
            }
        }
        
        // Excluir produto
        function deleteProduct(productId) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                products = products.filter(p => p.id !== parseInt(productId));
                // Salvar produtos atualizados no Firebase
                saveProductsToFirebase();
                loadProducts();
            }
        }
        
        // Receber pagamento
        function receivePayment(receivableId) {
            if (confirm('Deseja marcar este recebível como pago?')) {
                const receivable = receivables.find(r => r.id === parseInt(receivableId));
                if (receivable) {
                    receivable.status = 'paid';
                    // Salvar recebíveis atualizados no Firebase
                    saveReceivablesToFirebase();
                    loadReceivables();
                    updateDashboardReceivables();
                }
            }
        }
        
        // Buscar produtos
        function searchProducts() {
            const searchTerm = productSearchInput.value.toLowerCase();
            
            if (!searchTerm) {
                loadProducts();
                return;
            }
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.code.toLowerCase().includes(searchTerm)
            );
            
            productList.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                productList.innerHTML = '<div class="empty-cart"><p>Nenhum produto encontrado</p></div>';
                return;
            }
            
            filteredProducts.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.setAttribute('data-id', product.id);
                li.setAttribute('data-name', product.name);
                li.setAttribute('data-price', product.price);
                li.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div>R$ ${product.price.toFixed(2)} | Cód: ${product.code}</div>
                    </div>
                    <div class="product-stock ${product.stock <= 5 ? 'low-stock' : ''}">Estoque: ${product.stock}</div>
                `;
                productList.appendChild(li);
            });
        }
        
        // Buscar estoque
        function searchStock() {
            const searchTerm = stockSearchInput.value.toLowerCase();
            
            if (!searchTerm) {
                loadProducts();
                return;
            }
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.code.toLowerCase().includes(searchTerm)
            );
            
            stockList.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                stockList.innerHTML = '<div class="empty-cart"><p>Nenhum produto encontrado</p></div>';
                return;
            }
            
            filteredProducts.forEach(product => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div>Cód: ${product.code} | R$ ${product.price.toFixed(2)}</div>
                        <div>Custo: R$ ${product.cost.toFixed(2)} | Margem: ${calculateMargin(product.cost, product.price)}%</div>
                    </div>
                    <div class="product-stock ${product.stock <= 5 ? 'low-stock' : ''}">
                        ${product.stock} unid.
                        <div class="product-actions-small">
                            <i class="fas fa-edit edit-product" data-id="${product.id}"></i>
                            <i class="fas fa-trash delete-product" data-id="${product.id}"></i>
                        </div>
                    </div>
                `;
                stockList.appendChild(li);
            });
            
            // Adicionar event listeners para editar e excluir produtos
            document.querySelectorAll('.edit-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    editProduct(productId);
                });
            });
            
            document.querySelectorAll('.delete-product').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const productId = this.getAttribute('data-id');
                    deleteProduct(productId);
                });
            });
        }
        
        // Buscar clientes
        function searchClients() {
            const searchTerm = clientSearchInput.value.toLowerCase();
            
            if (!searchTerm) {
                loadClients();
                return;
            }
            
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) || 
                client.email.toLowerCase().includes(searchTerm) ||
                client.phone.toLowerCase().includes(searchTerm)
            );
            
            clientList.innerHTML = '';
            
            if (filteredClients.length === 0) {
                clientList.innerHTML = '<div class="empty-cart"><p>Nenhum cliente encontrado</p></div>';
                return;
            }
            
            filteredClients.forEach(client => {
                const li = document.createElement('li');
                li.className = 'client-item';
                li.innerHTML = `
                    <div class="client-info">
                        <strong>${client.name}</strong>
                        <div>${client.email} | ${client.phone}</div>
                        <div>Total em compras: R$ ${client.totalPurchases.toFixed(2)}</div>
                    </div>
                    <div class="client-actions">
                        <i class="fas fa-edit edit-client" data-id="${client.id}"></i>
                        <i class="fas fa-trash delete-client" data-id="${client.id}"></i>
                    </div>
                `;
                clientList.appendChild(li);
            });
            
            // Adicionar event listeners para editar e excluir
            document.querySelectorAll('.edit-client').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = this.getAttribute('data-id');
                    editClient(clientId);
                });
            });
            
            document.querySelectorAll('.delete-client').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const clientId = this.getAttribute('data-id');
                    deleteClient(clientId);
                });
            });
        }
        
        // Atualizar data e hora
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('pt-BR', options);
            
            // Capitalizar primeira letra
            const formattedDate = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            
            document.querySelector('.date-display').textContent = formattedDate;
        }
    </script>
</body>
</html>
